<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scanner Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    video { width: 100%; max-width: 420px; border: 1px solid #ccc; border-radius: 8px; }
    select, button { padding: 8px 10px; margin-right: 8px; }
    #log { white-space: pre-wrap; background:#f8f8ff; border:1px solid #ddd; padding:10px; max-width: 720px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px; }
  </style>
</head>
<body>
  <h1>ZXing Scanner Test</h1>

  <div class="row">
    <label for="cameraSelect">Camera:</label>
    <select id="cameraSelect"></select>
    <button id="startBtn">Start Scanner</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <video id="preview" autoplay muted playsinline></video>

  <p><strong>Last scan:</strong> <span id="lastScan">â€”</span></p>

  <h3>Log</h3>
  <div id="log">Readyâ€¦</div>

  <script>
    const logEl = document.getElementById('log');
    const lastScanEl = document.getElementById('lastScan');
    const cameraSelect = document.getElementById('cameraSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');

    function log(msg){ logEl.textContent += '\\n' + msg; }
    function setButtons(scanning){
      startBtn.disabled = scanning;
      stopBtn.disabled  = !scanning;
    }

    let codeReader = null;

    async function listCameras(){
      try {
        const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        log('Found cameras: ' + devices.length);
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if (devices.length === 0) {
          log('No cameras found. Check browser permission settings.');
        }
      } catch (e) {
        log('Error listing cameras: ' + e.message);
      }
    }

    async function startScanner(){
      try {
        setButtons(true);
        if (codeReader) await codeReader.reset();
        codeReader = new ZXing.BrowserMultiFormatReader();
        const deviceId = cameraSelect.value || undefined;

        await codeReader.decodeFromVideoDevice(deviceId, 'preview', (result, err) => {
          if (result) {
            const text = result.getText();
            lastScanEl.textContent = text;
            log('Scanned: ' + text);
          } else if (err && !(err instanceof ZXing.NotFoundException)) {
            log('Decode error: ' + err);
          }
        });
        log('Scanner started.');
      } catch (e) {
        log('Start error: ' + (e.message || e));
        setButtons(false);
      }
    }

    async function stopScanner(){
      try {
        if (codeReader) await codeReader.reset();
        log('Scanner stopped.');
      } catch(e){
        log('Stop error: ' + e.message);
      } finally {
        setButtons(false);
      }
    }

    // Init
    (async ()=>{
      await listCameras();
      log('If the camera list is empty, tap Start, accept the camera permission, then reload.');
    })();

    startBtn.onclick = startScanner;
    stopBtn.onclick  = stopScanner;
  </script>
  <!-- Settings Screen -->
<div id="settingsScreen" style="display:none; margin-top:20px; border:1px solid #ccc; padding:10px; border-radius:8px;">
  <h2>âš™ï¸ Punnet Settings</h2>
  <p>Change the number of punnets per crate and the weight per punnet (grams).</p>
  
  <table border="1" cellpadding="6" style="border-collapse:collapse;">
    <thead>
      <tr>
        <th>Size</th>
        <th>Punnets per Crate</th>
        <th>Punnet Weight (g)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Small</td>
        <td><input id="smallPunnets" type="number" value="32" /></td>
        <td><input id="smallWeight" type="number" value="250" /></td>
      </tr>
      <tr>
        <td>Medium</td>
        <td><input id="mediumPunnets" type="number" value="20" /></td>
        <td><input id="mediumWeight" type="number" value="400" /></td>
      </tr>
      <tr>
        <td>Large</td>
        <td><input id="largePunnets" type="number" value="8" /></td>
        <td><input id="largeWeight" type="number" value="800" /></td>
      </tr>
    </tbody>
  </table>

  <button onclick="saveSettings()" style="margin-top:10px;">ğŸ’¾ Save Settings</button>
</div>

<!-- Buttons to switch screens -->
<div style="margin-top:10px;">
  <button onclick="showScanner()">ğŸ“· Scanner</button>
  <button onclick="showSettings()">âš™ï¸ Settings</button>
</div>
</body>
</html>
