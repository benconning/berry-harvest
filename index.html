<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berry Harvest Scanner</title>
  <!-- ZXing for barcode/QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px 0; }
    .topbar { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    video { width: 100%; max-width: 420px; border: 1px solid #ccc; border-radius: 8px; }
    #log { white-space: pre-wrap; background:#f8f8ff; border:1px solid #ddd; padding:10px; max-width: 720px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>üçì Berry Harvest Scanner</h1>

  <!-- Top navigation -->
  <div class="topbar">
    <button id="btnScanner">üì∑ Scanner</button>
    <button id="btnSettings">‚öôÔ∏è Settings</button>
  </div>

  <!-- ========== Scanner Screen ========== -->
  <div id="scannerScreen">
    <div class="row">
      <label for="cameraSelect">Camera:</label>
      <select id="cameraSelect"></select>
      <button id="startBtn">Start Scanner</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <video id="preview" autoplay muted playsinline></video>

    <p><strong>Last scan:</strong> <span id="lastScan">‚Äî</span></p>

    <h3>Log</h3>
    <div id="log">Ready‚Ä¶</div>
  </div>

  <!-- ========== Settings Screen ========== -->
  <div id="settingsScreen" class="hidden" style="margin-top:20px; border:1px solid #ccc; padding:10px; border-radius:8px;">
    <h2>‚öôÔ∏è Punnet Settings</h2>
    <p>Change the number of punnets per crate and the weight per punnet (grams). These values are saved on this device.</p>
    
    <table>
      <thead>
        <tr>
          <th>Size</th>
          <th>Punnets per Crate</th>
          <th>Punnet Weight (g)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Small</td>
          <td><input id="smallPunnets" type="number" value="32" /></td>
          <td><input id="smallWeight" type="number" value="250" /></td>
        </tr>
        <tr>
          <td>Medium</td>
          <td><input id="mediumPunnets" type="number" value="20" /></td>
          <td><input id="mediumWeight" type="number" value="400" /></td>
        </tr>
        <tr>
          <td>Large</td>
          <td><input id="largePunnets" type="number" value="8" /></td>
          <td><input id="largeWeight" type="number" value="800" /></td>
        </tr>
      </tbody>
    </table>

    <button id="saveSettingsBtn" style="margin-top:10px;">üíæ Save Settings</button>
  </div>

  <script>
  // Wrap everything so we don't leak variables
  (function(){
    // ----------- UI helpers -----------
    const $ = (id) => document.getElementById(id);
    const scannerScreen  = $('scannerScreen');
    const settingsScreen = $('settingsScreen');
    const btnScanner  = $('btnScanner');
    const btnSettings = $('btnSettings');

    function showScanner(){
      settingsScreen.classList.add('hidden');
      scannerScreen.classList.remove('hidden');
    }
    function showSettings(){
      stopScanner();          // stop camera while on settings
      loadSettingsIntoForm(); // populate inputs
      scannerScreen.classList.add('hidden');
      settingsScreen.classList.remove('hidden');
    }

    // Bind buttons (no inline handlers)
    btnScanner.addEventListener('click', showScanner);
    btnSettings.addEventListener('click', showSettings);

    // ----------- Scanner -----------
    const logEl = $('log');
    const lastScanEl = $('lastScan');
    const cameraSelect = $('cameraSelect');
    const startBtn = $('startBtn');
    const stopBtn  = $('stopBtn');

    function log(msg){ logEl.textContent += '\\n' + msg; }
    function setButtons(scanning){
      startBtn.disabled = scanning;
      stopBtn.disabled  = !scanning;
    }

    let codeReader = null;

    async function listCameras(){
      try {
        const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        log('Found cameras: ' + devices.length);
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if (devices.length === 0) log('No cameras found. Check browser camera permission.');
      } catch (e) {
        log('Error listing cameras: ' + e.message);
      }
    }

    async function startScanner(){
      try {
        setButtons(true);
        if (codeReader) await codeReader.reset();
        codeReader = new ZXing.BrowserMultiFormatReader();
        const deviceId = cameraSelect.value || undefined;

        await codeReader.decodeFromVideoDevice(deviceId, 'preview', (result, err) => {
          if (result) {
            const text = result.getText();
            lastScanEl.textContent = text;
            log('Scanned: ' + text);
          } else if (err && !(err instanceof ZXing.NotFoundException)) {
            log('Decode error: ' + err);
          }
        });
        log('Scanner started.');
      } catch (e) {
        log('Start error: ' + (e.message || e));
        setButtons(false);
      }
    }

    async function stopScanner(){
      try {
        if (codeReader) await codeReader.reset();
        log('Scanner stopped.');
      } catch(e){
        log('Stop error: ' + e.message);
      } finally {
        setButtons(false);
      }
    }

    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click',  stopScanner);

    // On page load, prep camera list
    (async ()=>{
      await listCameras();
      log('If the camera list is empty, tap Start, accept the camera permission, then reload.');
    })();

    // ----------- Settings storage -----------
    // Default values in case nothing is saved yet
    const defaultPunnetSettings = {
      Small:  { punnetsPerCrate: 32, punnetWeightG: 250 },
      Medium: { punnetsPerCrate: 20, punnetWeightG: 400 },
      Large:  { punnetsPerCrate: 8,  punnetWeightG: 800 }
    };

    function getPunnetSettings(){
      const saved = localStorage.getItem('punnetSettings');
      return saved ? JSON.parse(saved) : { ...defaultPunnetSettings };
    }
    function setPunnetSettings(obj){
      localStorage.setItem('punnetSettings', JSON.stringify(obj));
    }

    function loadSettingsIntoForm(){
      const s = getPunnetSettings();
      $('smallPunnets').value = s.Small.punnetsPerCrate;
      $('smallWeight').value  = s.Small.punnetWeightG;
      $('mediumPunnets').value = s.Medium.punnetsPerCrate;
      $('mediumWeight').value  = s.Medium.punnetWeightG;
      $('largePunnets').value = s.Large.punnetsPerCrate;
      $('largeWeight').value  = s.Large.punnetWeightG;
    }

    function saveSettingsFromForm(){
      const s = {
        Small:  { punnetsPerCrate: parseInt($('smallPunnets').value || '0', 10), punnetWeightG: parseInt($('smallWeight').value  || '0', 10) },
        Medium: { punnetsPerCrate: parseInt($('mediumPunnets').value|| '0', 10), punnetWeightG: parseInt($('mediumWeight').value|| '0', 10) },
        Large:  { punnetsPerCrate: parseInt($('largePunnets').value || '0', 10), punnetWeightG: parseInt($('largeWeight').value || '0', 10) }
      };
      setPunnetSettings(s);
      alert('‚úÖ Settings saved!');
    }

    $('saveSettingsBtn').addEventListener('click', saveSettingsFromForm);

    // Start on scanner screen
    showScanner();
  })();
  </script>
</body>
</html>
