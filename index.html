<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berry Harvest</title>
  <!-- ZXing for barcode/QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px 0; }
    .topbar { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button { padding: 8px 12px; cursor: pointer; }
    select, input, textarea { padding: 6px 8px; }
    video { width: 100%; max-width: 460px; border: 1px solid #ccc; border-radius: 8px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:8px; padding:10px; margin-top:10px; }
    #log { white-space: pre-wrap; background:#f8f8ff; border:1px solid #ddd; padding:10px; max-width: 740px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    .hidden { display:none; }
    .pill { border:1px solid #ccc; padding:4px 8px; border-radius:999px; background:#f7f7ff; }
    .muted { color:#666; font-size: 13px; }
    .status { font-size:12px; color:#444; }
    textarea { width: 100%; min-height: 90px; }
    .spacer { flex:1 1 auto; }
  </style>
</head>
<body>
  <h1>üçì Berry Harvest</h1>

  <!-- Top navigation -->
  <div class="topbar">
    <button id="btnScanner"  onclick="goScanner()">üì∑ Scanner</button>
    <button id="btnRecords"  onclick="goRecords()">üìÑ Records</button>
    <button id="btnSettings" onclick="goSettings()">‚öôÔ∏è Settings</button>
    <span id="appStatus" class="status">Status: loading‚Ä¶</span>
  </div>

  <!-- ========== Scanner Screen ========== -->
  <div id="scannerScreen">
    <div class="card">
      <strong>Context (sticky)</strong>
      <div class="row" style="margin-top:6px">
        <label>Variety:
          <select id="varietySelect">
            <option value="">-- choose --</option>
          </select>
        </label>
        <label>Block:
          <select id="blockSelect">
            <option value="">-- choose --</option>
          </select>
        </label>
        <label>Size:
          <select id="sizeSelect">
            <option>Small</option>
            <option>Medium</option>
            <option>Large</option>
          </select>
        </label>
        <span class="muted">These stay until you change them.</span>
      </div>
    </div>

    <div class="card">
      <strong>Scanner</strong>
      <div class="row" style="margin-top:6px">
        <label for="cameraSelect">Camera:</label>
        <select id="cameraSelect"></select>
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <span class="pill" id="batchCount">Batch #<span id="batchIdLabel">1</span>: 0 crates</span>
        <span class="spacer"></span>
        <button id="completeBatchBtn" title="Finish this batch and start a new one">‚úÖ Complete Batch</button>
      </div>

      <video id="preview" autoplay muted playsinline></video>

      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="partialToggle"> Partial crate</label>
        <label>Manual punnets:
          <input id="manualPunnets" type="number" min="1" step="1" value="2" disabled>
        </label>
        <span class="muted">Use this only if the crate isn't full.</span>
      </div>

      <p><strong>Pending scan:</strong> <span id="lastScan">‚Äî</span></p>
      <div class="row" id="captureRow" style="display:none">
        <button id="captureBtn">‚úÖ Capture</button>
        <button id="rescanBtn">‚Üª Rescan</button>
        <span class="muted">Scanner paused until you choose.</span>
      </div>

      <div id="log" class="muted">Ready‚Ä¶</div>
    </div>
  </div>

  <!-- ========== Records Screen ========== -->
  <div id="recordsScreen" class="hidden">
    <div class="card">
      <div class="row">
        <label>Filter:
          <select id="dateFilter">
            <option value="today">Today</option>
            <option value="7">Last 7 days</option>
            <option value="month">This month</option>
            <option value="all">All</option>
          </select>
        </label>
        <button id="exportCSVBtn">Export CSV</button>
        <button id="clearAllBtn" style="margin-left:auto;">Clear All</button>
      </div>
      <div class="row">
        <span class="pill">Rows: <span id="rowsCount">0</span></span>
        <span class="pill">Punnets: <span id="totalPunnets">0</span></span>
        <span class="pill">Kg: <span id="totalKg">0.00</span></span>
      </div>
      <div style="max-height: 420px; overflow:auto; margin-top:8px;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Picker</th>
              <th>Crate</th>
              <th>Variety</th>
              <th>Block</th>
              <th>Size</th>
              <th>Punnets</th>
              <th>Kg</th>
              <th>Batch</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ========== Settings Screen ========== -->
  <div id="settingsScreen" class="hidden">
    <div class="card">
      <h2>‚öôÔ∏è Punnet Settings</h2>
      <p>Change the number of punnets per crate and the weight per punnet (grams). Saved on this device.</p>

      <table>
        <thead>
          <tr>
            <th>Size</th>
            <th>Punnets per Crate</th>
            <th>Punnet Weight (g)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Small</td>
            <td><input id="smallPunnets" type="number" value="32" /></td>
            <td><input id="smallWeight" type="number" value="250" /></td>
          </tr>
          <tr>
            <td>Medium</td>
            <td><input id="mediumPunnets" type="number" value="20" /></td>
            <td><input id="mediumWeight" type="number" value="400" /></td>
          </tr>
          <tr>
            <td>Large</td>
            <td><input id="largePunnets" type="number" value="8" /></td>
            <td><input id="largeWeight" type="number" value="800" /></td>
          </tr>
        </tbody>
      </table>

      <button id="saveSettingsBtn" style="margin-top:10px;">üíæ Save Punnet Settings</button>
    </div>

    <div class="card">
      <h2>üìã Master Lists</h2>
      <p>Enter one per line. These lists feed the Scanner dropdowns.</p>
      <div class="row">
        <div style="flex:1 1 300px;">
          <h3 style="margin:6px 0 6px;">Varieties</h3>
          <textarea id="varietiesText"></textarea>
        </div>
        <div style="flex:1 1 300px;">
          <h3 style="margin:6px 0 6px;">Blocks</h3>
          <textarea id="blocksText"></textarea>
        </div>
      </div>
      <button id="saveListsBtn">üíæ Save Lists</button>
    </div>
  </div>

  <script>
  (function(){
    // ----------------- Utilities -----------------
    const $ = (id) => document.getElementById(id);
    const setStatus = (t)=> { const el = $('appStatus'); if (el) el.textContent = t; };
    const fmtKg = (n) => Number(n).toFixed(2);
    const nowISO = () => new Date().toISOString();

    // ----------------- Navigation -----------------
    const screens = {
      scanner: $('scannerScreen'),
      records: $('recordsScreen'),
      settings: $('settingsScreen')
    };
    function show(screen){
      Object.values(screens).forEach(s => s.classList.add('hidden'));
      screens[screen].classList.remove('hidden');
      setStatus('Status: showing ' + screen);
    }
    window.goScanner = ()=> show('scanner');
    window.goRecords = ()=> { renderRecords(); show('records'); };
    window.goSettings = ()=> { stopScanner(); loadSettingsIntoForm(); loadListsIntoForm(); show('settings'); };

    // ----------------- Punnet Settings -----------------
    const defaultPunnetSettings = {
      Small:  { punnetsPerCrate: 32, punnetWeightG: 250 },
      Medium: { punnetsPerCrate: 20, punnetWeightG: 400 },
      Large:  { punnetsPerCrate: 8,  punnetWeightG: 800 }
    };
    function getPunnetSettings(){
      const saved = localStorage.getItem('punnetSettings');
      return saved ? JSON.parse(saved) : { ...defaultPunnetSettings };
    }
    function setPunnetSettings(obj){
      localStorage.setItem('punnetSettings', JSON.stringify(obj));
    }
    function loadSettingsIntoForm(){
      const s = getPunnetSettings();
      $('smallPunnets').value = s.Small.punnetsPerCrate;
      $('smallWeight').value  = s.Small.punnetWeightG;
      $('mediumPunnets').value = s.Medium.punnetsPerCrate;
      $('mediumWeight').value  = s.Medium.punnetWeightG;
      $('largePunnets').value = s.Large.punnetsPerCrate;
      $('largeWeight').value  = s.Large.punnetWeightG;
    }
    $('saveSettingsBtn').onclick = ()=>{
      const s = {
        Small:  { punnetsPerCrate: parseInt($('smallPunnets').value||'0',10), punnetWeightG: parseInt($('smallWeight').value||'0',10) },
        Medium: { punnetsPerCrate: parseInt($('mediumPunnets').value||'0',10), punnetWeightG: parseInt($('mediumWeight').value||'0',10) },
        Large:  { punnetsPerCrate: parseInt($('largePunnets').value||'0',10),  punnetWeightG: parseInt($('largeWeight').value||'0',10) }
      };
      setPunnetSettings(s);
      alert('‚úÖ Punnet settings saved!');
    };

    // ----------------- Master Lists (Varieties/Blocks) -----------------
    const defaultVarieties = ['Albion','Camarosa','Ventana'];
    const defaultBlocks = ['GH1-R01','GH2-R12','Block 5'];

    function getVarieties(){
      const raw = localStorage.getItem('varieties');
      return raw ? JSON.parse(raw) : defaultVarieties.slice();
    }
    function setVarieties(list){
      localStorage.setItem('varieties', JSON.stringify(list));
    }
    function getBlocks(){
      const raw = localStorage.getItem('blocks');
      return raw ? JSON.parse(raw) : defaultBlocks.slice();
    }
    function setBlocks(list){
      localStorage.setItem('blocks', JSON.stringify(list));
    }

    function loadListsIntoForm(){
      $('varietiesText').value = getVarieties().join('\\n');
      $('blocksText').value = getBlocks().join('\\n');
    }

    function saveListsFromForm(){
      const v = $('varietiesText').value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      const b = $('blocksText').value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      if (v.length === 0 || b.length === 0){
        alert('Please enter at least one Variety and one Block.');
        return;
      }
      setVarieties(v);
      setBlocks(b);
      populateVarietyBlockOptions(); // update scanner dropdowns
      alert('‚úÖ Master lists saved!');
    }
    $('saveListsBtn').onclick = saveListsFromForm;

    function populateVarietyBlockOptions(){
      const vlist = getVarieties();
      const blist = getBlocks();
      // Variety dropdown
      const varietySelect = $('varietySelect');
      const oldVar = varietySelect.value;
      varietySelect.innerHTML = '<option value="">-- choose --</option>';
      vlist.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        varietySelect.appendChild(opt);
      });
      // Block dropdown
      const blockSelect = $('blockSelect');
      const oldBlock = blockSelect.value;
      blockSelect.innerHTML = '<option value="">-- choose --</option>';
      blist.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        blockSelect.appendChild(opt);
      });
      // try to keep prior selection if still present
      if (vlist.includes(oldVar)) varietySelect.value = oldVar;
      if (blist.includes(oldBlock)) blockSelect.value = oldBlock;
    }

    // ----------------- Sticky context -----------------
    function loadContext(){
      try { return JSON.parse(localStorage.getItem('scanContext')||'{}'); } catch(e){ return {}; }
    }
    function saveContext(ctx){
      localStorage.setItem('scanContext', JSON.stringify(ctx));
    }
    const varietySelect = $('varietySelect');
    const blockSelect   = $('blockSelect');
    const sizeSelect    = $('sizeSelect');

    // init lists and restore context
    populateVarietyBlockOptions();
    (()=>{
      const ctx = loadContext();
      if (ctx.variety) varietySelect.value = ctx.variety;
      if (ctx.block)   blockSelect.value = ctx.block;
      if (ctx.size)    sizeSelect.value = ctx.size;
    })();
    [varietySelect,blockSelect,sizeSelect].forEach(el=>{
      el.addEventListener('change', ()=>{
        saveContext({ variety: varietySelect.value, block: blockSelect.value, size: sizeSelect.value });
      });
    });

    // ----------------- Records store -----------------
    function getRecords(){
      try { return JSON.parse(localStorage.getItem('harvestRecords')||'[]'); } catch(e){ return []; }
    }
    function setRecords(arr){
      localStorage.setItem('harvestRecords', JSON.stringify(arr));
    }

    // ----------------- Batch handling -----------------
    function getCurrentBatchId(){
      return parseInt(localStorage.getItem('currentBatchId') || '1', 10);
    }
    function setCurrentBatchId(n){
      localStorage.setItem('currentBatchId', String(n));
      $('batchIdLabel').textContent = n;
    }
    function completeBatch(){
      const newId = getCurrentBatchId() + 1;
      setCurrentBatchId(newId);
      // reset on-screen count
      batchCountEl.dataset.count = 0;
      batchCountEl.textContent = `Batch #${newId}: 0 crates`;
      alert(`‚úÖ Batch completed. Now on Batch #${newId}.`);
    }
    $('completeBatchBtn').onclick = ()=> completeBatch();
    // init batch label
    setCurrentBatchId(getCurrentBatchId());

    // ----------------- QR Parsing -----------------
    function parseKV(text){
      const out = { raw: text||'' };
      if(!text) return out;
      text.split(/[;,\n]/).forEach(pair=>{
        const [k,...rest] = pair.split('=');
        if(rest.length){
          out[k.trim().toLowerCase()] = rest.join('=').trim();
        }
      });
      if (!out.picker && /^[A-Za-z]\\d{2,}$/.test(out.raw||'')) out.picker = out.raw.trim();
      return out;
    }

    // ----------------- Scanner with Capture Button -----------------
    const logEl = $('log');
    const lastScanEl = $('lastScan');
    const cameraSelect = $('cameraSelect');
    const startBtn = $('startBtn');
    const stopBtn  = $('stopBtn');
    const batchCountEl = $('batchCount');
    const partialToggle = $('partialToggle');
    const manualPunnets = $('manualPunnets');
    const captureRow = $('captureRow');
    const captureBtn = $('captureBtn');
    const rescanBtn  = $('rescanBtn');

    function log(msg){ if (logEl) logEl.textContent += '\\n' + msg; }
    function setButtons(scanning){
      if (startBtn) startBtn.disabled = scanning;
      if (stopBtn)  stopBtn.disabled  = !scanning;
    }

    partialToggle.onchange = ()=>{ manualPunnets.disabled = !partialToggle.checked; };

    let codeReader = null;
    let pendingText = '';

    async function listCameras(){
      try {
        const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        log('Found cameras: ' + devices.length);
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if (devices.length === 0) log('No cameras found. Check browser camera permission.');
      } catch (e) {
        log('Error listing cameras: ' + e.message);
      }
    }

    async function startScanner(){
      try {
        setButtons(true);
        captureRow.style.display = 'none';
        pendingText = '';
        lastScanEl.textContent = '‚Äî';

        if (codeReader) await codeReader.reset();
        codeReader = new ZXing.BrowserMultiFormatReader();
        const deviceId = cameraSelect.value || undefined;

        await codeReader.decodeFromVideoDevice(deviceId, 'preview', async (result, err) => {
          if (result) {
            await pauseScanner();
            pendingText = result.getText();
            lastScanEl.textContent = pendingText;
            captureRow.style.display = 'flex';
            log('Detected QR ‚Äî paused. Tap Capture to save or Rescan to try again.');
          } else if (err && !(err instanceof ZXing.NotFoundException)) {
            log('Decode error: ' + err);
          }
        });
        log('Scanner started.');
      } catch (e) {
        log('Start error: ' + (e.message || e));
        setButtons(false);
      }
    }

    async function pauseScanner(){
      try {
        if (codeReader) await codeReader.reset();
      } catch(e){
        log('Pause error: ' + e.message);
      } finally {
        setButtons(false);
      }
    }

    async function stopScanner(){
      pendingText = '';
      captureRow.style.display = 'none';
      lastScanEl.textContent = '‚Äî';
      try {
        if (codeReader) await codeReader.reset();
        log('Scanner stopped.');
      } catch(e){
        log('Stop error: ' + e.message);
      } finally {
        setButtons(false);
      }
    }

    startBtn.onclick = startScanner;
    stopBtn.onclick  = stopScanner;

    captureBtn.onclick = async ()=>{
      if (!pendingText) return;
      handleScan(pendingText);
      pendingText = '';
      captureRow.style.display = 'none';
      await startScanner();
    };

    rescanBtn.onclick = async ()=>{
      pendingText = '';
      captureRow.style.display = 'none';
      lastScanEl.textContent = '‚Äî';
      await startScanner();
    };

    function handleScan(rawText){
      const kv = parseKV(rawText);
      const ctx = loadContext();
      const size = ctx.size || 'Small';
      const variety = ctx.variety || '';
      const block   = ctx.block || '';

      const settings = getPunnetSettings();
      const sizeCfg = settings[size] || settings.Small;

      const isPartial = !!partialToggle.checked;
      const manual = parseInt(manualPunnets.value||'0',10);
      const punnets = isPartial ? Math.max(1, manual) : sizeCfg.punnetsPerCrate;
      const kg = (punnets * sizeCfg.punnetWeightG) / 1000;

      const rec = {
        timestamp: nowISO(),
        picker_id: kv.picker || 'Unknown',
        crate_id:  kv.crate || kv.crateid || '',
        variety: variety,
        block: block,
        size: size,
        punnets_per_crate: sizeCfg.punnetsPerCrate,
        is_partial: isPartial,
        manual_punnets: isPartial ? punnets : null,
        crate_qty: 1,
        punnets_total: punnets,
        punnet_weight_g: sizeCfg.punnetWeightG,
        kg: Number(kg.toFixed(3)),
        batch_id: getCurrentBatchId(),
        scan_raw: rawText
      };

      const all = getRecords();
      all.push(rec);
      setRecords(all);

      const newCount = Number(batchCountEl.dataset.count || '0') + 1;
      batchCountEl.dataset.count = newCount;
      batchCountEl.textContent = `Batch #${getCurrentBatchId()}: ${newCount} crates`;

      if (isPartial) { partialToggle.checked = false; manualPunnets.disabled = true; }

      log(`Captured: [Batch #${rec.batch_id}] ${rec.picker_id} ‚Ä¢ ${rec.size} ‚Ä¢ ${rec.punnets_total} punnets = ${rec.kg} kg`);
    }

    // Prepare on load
    (async ()=>{
      setStatus('Status: JS loaded, showing scanner');
      await listCameras();
      show('scanner');
      log('Tap Start, scan a code, then Capture/Rescan. Use ‚úÖ Complete Batch to start a new batch number.');
    })();

    // ----------------- Records page -----------------
    const dateFilter = $('dateFilter');
    const rowsCount = $('rowsCount');
    const totalPunnets = $('totalPunnets');
    const totalKg = $('totalKg');
    const recordsTableBody = $('recordsTable').querySelector('tbody');

    if (dateFilter) dateFilter.onchange = ()=> renderRecords();

    function withinFilter(ts, filterVal){
      const t = new Date(ts);
      const now = new Date();
      if (filterVal === 'all') return true;
      if (filterVal === 'today'){
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return t >= start;
      }
      if (filterVal === '7'){
        const start = new Date(now);
        start.setDate(now.getDate() - 6);
        start.setHours(0,0,0,0);
        return t >= start;
      }
      if (filterVal === 'month'){
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return t >= start;
      }
      return true;
    }

    function renderRecords(){
      const all = getRecords();
      const filt = (dateFilter && dateFilter.value) ? dateFilter.value : 'today';
      const rows = all.filter(r => withinFilter(r.timestamp, filt));

      const punnetsSum = rows.reduce((s,r)=> s + Number(r.punnets_total||0), 0);
      const kgSum = rows.reduce((s,r)=> s + Number(r.kg||0), 0);

      if (rowsCount) rowsCount.textContent = rows.length;
      if (totalPunnets) totalPunnets.textContent = punnetsSum;
      if (totalKg) totalKg.textContent = fmtKg(kgSum);

      recordsTableBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.timestamp).toLocaleString()}</td>
          <td>${r.picker_id}</td>
          <td>${r.crate_id||''}</td>
          <td>${r.variety||''}</td>
          <td>${r.block||''}</td>
          <td>${r.size}</td>
          <td>${r.punnets_total}</td>
          <td>${fmtKg(r.kg)}</td>
          <td>#${r.batch_id||''}</td>
          <td class="muted" title="${(r.scan_raw||'').replace(/"/g,'&quot;')}">${(r.scan_raw||'').slice(0,20)}</td>
        `;
        recordsTableBody.appendChild(tr);
      });
    }

    // Export CSV
    $('exportCSVBtn').onclick = ()=>{
      const cols = ['timestamp','picker_id','crate_id','variety','block','size','punnets_per_crate','crate_qty','is_partial','manual_punnets','punnets_total','punnet_weight_g','kg','batch_id','scan_raw'];
      const all = getRecords();
      const filt = dateFilter.value || 'today';
      const rows = all.filter(r => withinFilter(r.timestamp, filt));

      const header = cols.join(',');
      const body = rows.map(r => cols.map(c => {
        const v = (r[c]===undefined || r[c]===null) ? '' : String(r[c]);
        if (/[,"\n]/.test(v)) return '"' + v.replace(/"/g,'""') + '"';
        return v;
      }).join(','));
      const csv = [header, ...body].join('\n');

      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `harvest_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Clear all
    $('clearAllBtn').onclick = ()=>{
      if(confirm('Clear ALL saved records on this device?')){
        setRecords([]);
        renderRecords();
      }
    };
  })();
  </script>
</body>
</html>
