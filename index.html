<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Market Garden Management System</title>
    
    <!-- ============= STYLES ============= -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 16px;
            background: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #6b8e23 0%, #8fbc8f 100%);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .home-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .home-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .home-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        /* Screens */
        .screen {
            display: none;
            padding: 20px;
            max-width: 100%;
            animation: fadeIn 0.3s;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Home tiles */
        .tiles-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .tile {
            background: #e6f3ff;
            border: 2px solid #4a90e2;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tile:active {
            transform: translateY(0);
        }
        
        .tile .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }
        
        /* Buttons */
        .btn {
            background: #e6f3ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 60px;
            font-weight: 500;
            margin: 5px;
        }
        
        .btn:hover {
            background: #d0e7ff;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #4a90e2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #357abd;
        }
        
        .btn-danger {
            background: #ff6b6b;
            border-color: #ff5252;
            color: white;
        }
        
        .btn-success {
            background: #51cf66;
            border-color: #40c057;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Batch pill */
        .batch-pill {
            background: #6b8e23;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        /* Scanner overlay */
        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 1000;
            display: none;
        }
        
        .scanner-overlay.active {
            display: flex;
            flex-direction: column;
        }
        
        .scanner-header {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1001;
        }
        
        .scanner-close {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .scanner-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #captureCanvas {
            display: none;
        }
        
        .scanner-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        
        #captureBtn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 5px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        #captureBtn:active {
            transform: scale(0.9);
        }
        
        /* Picker Tally Box */
        .picker-tally-container {
            background: white;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .picker-tally-container h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .picker-tally-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .picker-tally-name {
            font-weight: 500;
            color: #333;
        }
        
        .picker-tally-count {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .picker-tally-count input {
            width: 70px;
            padding: 5px 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        /* Stats cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .editable-cell {
            cursor: pointer;
            position: relative;
        }
        
        .editable-cell:hover {
            background: #e3f2fd;
        }
        
        .edit-input {
            width: 100%;
            padding: 5px;
            border: 2px solid #4a90e2;
            border-radius: 4px;
        }
        
        .action-btn {
            padding: 5px 10px;
            font-size: 14px;
            min-height: auto;
            margin: 2px;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Filters */
        .filters-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Settings */
        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        /* Employee tiles */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .employee-tile {
            background: white;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .employee-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .employee-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f0f0f0;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            overflow: hidden;
        }
        
        .employee-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .employee-name {
            font-weight: 500;
            color: #333;
        }
        
        /* Camera preview for clock in/out */
        .camera-preview {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .camera-preview video {
            width: 100%;
            border-radius: 10px;
        }
        
        .camera-preview img {
            width: 100%;
            border-radius: 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        /* Responsive adjustments */
        @media (max-width: 375px) {
            .header {
                font-size: 18px;
                padding: 15px;
            }
            
            .tile {
                padding: 20px;
                font-size: 18px;
            }
            
            .btn {
                font-size: 16px;
                padding: 12px 20px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- ============= HTML MARKUP ============= -->
    <div class="header">
        <button class="home-btn" onclick="goHome()" style="display: none;">üè†</button>
        <span id="headerTitle">Market Garden Management System</span>
    </div>
    
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Home Screen -->
    <div class="screen active" id="homeScreen">
        <div class="tiles-container">
            <div class="tile" onclick="navigateToScreen('strawberryScreen')">
                <div class="emoji">üçì</div>
                <div>Strawberry</div>
            </div>
            <div class="tile" onclick="navigateToScreen('employeeMenuScreen')">
                <div class="emoji">üë•</div>
                <div>Employee</div>
            </div>
            <div class="tile" onclick="navigateToScreen('recordsScreen')">
                <div class="emoji">üìÑ</div>
                <div>Records</div>
            </div>
            <div class="tile" onclick="navigateToScreen('settingsMenuScreen')">
                <div class="emoji">‚öôÔ∏è</div>
                <div>Settings</div>
            </div>
        </div>
    </div>
    
    <!-- Employee Menu Screen -->
    <div class="screen" id="employeeMenuScreen">
        <div class="tiles-container">
            <div class="tile" onclick="navigateToScreen('enrollEmployeeScreen')">
                <div class="emoji">‚ûï</div>
                <div>Enrol New Employee</div>
            </div>
            <div class="tile" onclick="navigateToScreen('clockInOutMenuScreen')">
                <div class="emoji">‚è∞</div>
                <div>Clock In/Out</div>
            </div>
            <div class="tile" onclick="navigateToScreen('printStickersScreen')">
                <div class="emoji">üñ®Ô∏è</div>
                <div>Print Stickers</div>
            </div>
            <div class="tile" onclick="navigateToScreen('timeRecordsScreen')">
                <div class="emoji">üìã</div>
                <div>View Time Records</div>
            </div>
        </div>
    </div>
    
    <!-- Enrol Employee Screen -->
    <div class="screen" id="enrollEmployeeScreen">
        <h2>Enrol New Employee</h2>
        <div class="form-group">
            <label for="employeeName">Employee Name *</label>
            <input type="text" id="employeeName" required placeholder="Enter full name">
        </div>
        <div class="form-group">
            <label for="employeePhone">Phone Number</label>
            <input type="tel" id="employeePhone" placeholder="Enter phone number">
        </div>
        <div class="form-group">
            <label for="employeeEmail">Email Address</label>
            <input type="email" id="employeeEmail" placeholder="Enter email address">
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="enrollEmployee()">Enrol Employee</button>
        </div>
    </div>
    
    <!-- Clock In/Out Menu Screen -->
    <div class="screen" id="clockInOutMenuScreen">
        <div class="tiles-container">
            <div class="tile" onclick="navigateToScreen('clockInScreen')">
                <div class="emoji">‚úÖ</div>
                <div>Clock In</div>
            </div>
            <div class="tile" onclick="navigateToScreen('clockOutScreen')">
                <div class="emoji">üö™</div>
                <div>Clock Out</div>
            </div>
        </div>
    </div>
    
    <!-- Clock In Screen -->
    <div class="screen" id="clockInScreen">
        <h2>Clock In</h2>
        <p style="margin-bottom: 20px; color: #666;">Select your name to clock in</p>
        <div class="employee-grid" id="clockInEmployeeGrid"></div>
    </div>
    
    <!-- Clock Out Screen -->
    <div class="screen" id="clockOutScreen">
        <h2>Clock Out</h2>
        <p style="margin-bottom: 20px; color: #666;">Select your name to clock out</p>
        <div class="employee-grid" id="clockOutEmployeeGrid"></div>
    </div>
    
    <!-- Camera Modal for Clock In/Out -->
    <div class="modal" id="clockCameraModal">
        <div class="modal-content">
            <div class="modal-header" id="clockModalHeader">Take Photo</div>
            <div class="camera-preview">
                <video id="clockVideo" autoplay playsinline></video>
                <img id="clockPhotoPreview" style="display: none;">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="clockCaptureBtn" onclick="captureClockPhoto()">Take Photo</button>
                <button class="btn btn-success" id="clockConfirmBtn" style="display: none;" onclick="confirmClockPhoto()">Confirm</button>
                <button class="btn" id="clockRetakeBtn" style="display: none;" onclick="retakeClockPhoto()">Retake</button>
                <button class="btn" onclick="closeClockCamera()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Print Stickers Screen -->
    <div class="screen" id="printStickersScreen">
        <h2>Print Employee Stickers</h2>
        <div class="form-group">
            <label for="stickerEmployee">Select Employee *</label>
            <select id="stickerEmployee" required></select>
        </div>
        <div class="form-group">
            <label for="stickerQuantity">Number of Stickers *</label>
            <input type="number" id="stickerQuantity" min="1" value="10" required>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="printStickers()">Generate Stickers</button>
        </div>
        <div id="stickerPreview"></div>
    </div>
    
    <!-- Time Records Screen -->
    <div class="screen" id="timeRecordsScreen">
        <h2>Time Records</h2>
        <div class="filters-container">
            <div class="filter-row">
                <div class="form-group">
                    <label for="timeRecordsFilter">Filter</label>
                    <select id="timeRecordsFilter" onchange="loadTimeRecords()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeRecordsEmployee">Employee</label>
                    <select id="timeRecordsEmployee" onchange="loadTimeRecords()">
                        <option value="all">All Employees</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="timeRecordsContainer"></div>
        <div class="btn-group">
            <button class="btn" onclick="exportTimeRecords()">üì• Export CSV</button>
        </div>
    </div>
    
    <!-- Settings Menu Screen -->
    <div class="screen" id="settingsMenuScreen">
        <div class="tiles-container">
            <div class="tile" onclick="navigateToScreen('pickingSettingsScreen')">
                <div class="emoji">üçì</div>
                <div>Picking Settings</div>
            </div>
            <div class="tile" onclick="navigateToScreen('employeeSettingsScreen')">
                <div class="emoji">üë•</div>
                <div>Employee Settings</div>
            </div>
            <div class="tile" onclick="navigateToScreen('dataSettingsScreen')">
                <div class="emoji">üìä</div>
                <div>Data Settings</div>
            </div>
        </div>
    </div>
    
    <!-- Picking Settings Screen -->
    <div class="screen" id="pickingSettingsScreen">
        <h2>Picking Settings</h2>
        
        <div class="settings-section">
            <h3>Punnet Settings</h3>
            
            <h4 style="margin-top: 20px; color: #666;">Small Punnets</h4>
            <div class="form-group">
                <label for="smallPunnets">Punnets per Crate</label>
                <input type="number" id="smallPunnets" value="32">
            </div>
            <div class="form-group">
                <label for="smallWeight">Weight per Punnet (grams)</label>
                <input type="number" id="smallWeight" value="250">
            </div>
            
            <h4 style="margin-top: 20px; color: #666;">Medium Punnets</h4>
            <div class="form-group">
                <label for="mediumPunnets">Punnets per Crate</label>
                <input type="number" id="mediumPunnets" value="20">
            </div>
            <div class="form-group">
                <label for="mediumWeight">Weight per Punnet (grams)</label>
                <input type="number" id="mediumWeight" value="400">
            </div>
            
            <h4 style="margin-top: 20px; color: #666;">Large Punnets</h4>
            <div class="form-group">
                <label for="largePunnets">Punnets per Crate</label>
                <input type="number" id="largePunnets" value="8">
            </div>
            <div class="form-group">
                <label for="largeWeight">Weight per Punnet (grams)</label>
                <input type="number" id="largeWeight" value="800">
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Master Lists</h3>
            <div class="form-group">
                <label for="varietiesList">Varieties (one per line)</label>
                <textarea id="varietiesList" rows="6" placeholder="e.g.&#10;Albion&#10;San Andreas&#10;Monterey"></textarea>
            </div>
            <div class="form-group">
                <label for="blocksList">Blocks (one per line)</label>
                <textarea id="blocksList" rows="6" placeholder="e.g.&#10;Block A&#10;Block B&#10;Block C"></textarea>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-success" onclick="savePickingSettings()">Save Settings</button>
        </div>
    </div>
    
    <!-- Employee Settings Screen -->
    <div class="screen" id="employeeSettingsScreen">
        <h2>Employee Settings</h2>
        <div class="settings-section">
            <p style="color: #666; font-style: italic;">Employee settings to be configured (TBC)</p>
        </div>
    </div>
    
    <!-- Data Settings Screen -->
    <div class="screen" id="dataSettingsScreen">
        <h2>Data Settings</h2>
        <div class="settings-section">
            <h3>Plants per Block</h3>
            <div id="plantsPerBlockContainer"></div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="savePlantsPerBlock()">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Strawberry Screen -->
    <div class="screen" id="strawberryScreen">
        <div class="batch-pill" id="batchPill">Batch #1 - 0 crates</div>
        
        <div class="form-group">
            <label for="variety">Variety</label>
            <select id="variety"></select>
        </div>
        
        <div class="form-group">
            <label for="block">Block</label>
            <select id="block"></select>
        </div>
        
        <div class="form-group">
            <label for="size">Size</label>
            <select id="size">
                <option value="">Select Size</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="partialCrate"> Partial Crate
            </label>
        </div>
        
        <div class="form-group" id="manualPunnets" style="display: none;">
            <label for="manualPunnetsInput">Number of Punnets in Partial Crate</label>
            <input type="number" id="manualPunnetsInput" min="1" placeholder="e.g. 5">
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="openScanner()">üì∑ Photo Scan</button>
            <button class="btn" onclick="finishBatch()">‚úÖ Finish Batch</button>
        </div>
        
        <!-- Picker Tally -->
        <div class="picker-tally-container" id="pickerTallyContainer" style="display: none;">
            <h3>Picker Tally</h3>
            <div id="pickerTallyList"></div>
        </div>
    </div>
    
    <!-- Scanner Overlay -->
    <div class="scanner-overlay" id="scannerOverlay">
        <div class="scanner-header">
            <div id="scanStatus">Ready to scan</div>
            <button class="scanner-close" onclick="closeScanner()">‚úï</button>
        </div>
        <div class="scanner-content">
            <video id="videoPreview" autoplay playsinline></video>
            <canvas id="captureCanvas"></canvas>
            <div class="scanner-controls">
                <button id="captureBtn" onclick="captureImage()"></button>
            </div>
        </div>
    </div>
    
    <!-- Records Screen -->
    <div class="screen" id="recordsScreen">
        <div class="filters-container">
            <div class="filter-row">
                <div class="form-group">
                    <label for="filterTime">Time Period</label>
                    <select id="filterTime">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterVariety">Variety</label>
                    <select id="filterVariety">
                        <option value="all">All Varieties</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterBlock">Block</label>
                    <select id="filterBlock">
                        <option value="all">All Blocks</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterGroupBy">Group By</label>
                    <select id="filterGroupBy">
                        <option value="none">No Grouping</option>
                        <option value="variety">Variety</option>
                        <option value="block">Block</option>
                        <option value="size">Size</option>
                        <option value="picker">Picker</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="statCrates">0</div>
                <div class="stat-label">Crates</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPunnets">0</div>
                <div class="stat-label">Punnets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statKg">0.0</div>
                <div class="stat-label">Kg</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statKgPerPlant">0.0</div>
                <div class="stat-label">Kg/Plant</div>
            </div>
        </div>
        
        <div id="groupedContainer"></div>
        <div id="recordsTableContainer"></div>
        
        <div class="btn-group">
            <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
            <button class="btn" onclick="addManualRecord()">‚ûï Add Record</button>
            <button class="btn btn-danger" onclick="clearAllRecords()">üóëÔ∏è Clear All</button>
        </div>
    </div>
    
    <!-- Manual Record Modal -->
    <div class="modal" id="manualRecordModal">
        <div class="modal-content">
            <div class="modal-header">Add Manual Record</div>
            <div class="form-group">
                <label for="manualDate">Date *</label>
                <input type="date" id="manualDate" required>
            </div>
            <div class="form-group">
                <label for="manualPicker">Picker *</label>
                <select id="manualPicker" required></select>
            </div>
            <div class="form-group">
                <label for="manualVariety">Variety *</label>
                <select id="manualVariety" required></select>
            </div>
            <div class="form-group">
                <label for="manualBlock">Block *</label>
                <select id="manualBlock" required></select>
            </div>
            <div class="form-group">
                <label for="manualSize">Size *</label>
                <select id="manualSize" required>
                    <option value="">Select Size</option>
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                </select>
            </div>
            <div class="form-group">
                <label for="manualCrates">Number of Crates *</label>
                <input type="number" id="manualCrates" min="0" required>
            </div>
            <div class="form-group">
                <label for="manualPartialPunnets">Punnets in Partial Crate (optional)</label>
                <input type="number" id="manualPartialPunnets" min="0" placeholder="Leave blank if none">
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveManualRecord()">Save</button>
                <button class="btn" onclick="closeManualRecordModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Record Modal -->
    <div class="modal" id="editRecordModal">
        <div class="modal-content">
            <div class="modal-header">Edit Record</div>
            <input type="hidden" id="editRecordIndex">
            <div class="form-group">
                <label for="editPicker">Picker</label>
                <select id="editPicker"></select>
            </div>
            <div class="form-group">
                <label for="editVariety">Variety</label>
                <select id="editVariety"></select>
            </div>
            <div class="form-group">
                <label for="editBlock">Block</label>
                <select id="editBlock"></select>
            </div>
            <div class="form-group">
                <label for="editSize">Size</label>
                <select id="editSize">
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editCrates">Crates</label>
                <input type="number" id="editCrates" min="0">
            </div>
            <div class="form-group">
                <label for="editPartialPunnets">Punnets in Partial Crate</label>
                <input type="number" id="editPartialPunnets" min="0" placeholder="0">
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveEditedRecord()">Save Changes</button>
                <button class="btn btn-danger" onclick="deleteEditedRecord()">Delete</button>
                <button class="btn" onclick="closeEditRecordModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- ============= JAVASCRIPT ============= -->
    <script>
        // ============= GLOBAL VARIABLES =============
        let currentStream = null;
        let currentBatchCrates = 0;
        let currentClockEmployee = null;
        let currentClockAction = null;
        let clockPhotoStream = null;
        let clockPhotoData = null;
        let pickerTallies = {}; // Track crates per picker
        
        // ============= STORAGE FUNCTIONS =============
        function saveToStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }
        
        function getFromStorage(key, defaultValue = null) {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultValue;
        }
        
        function initializeStorage() {
            // Initialize default settings if not present
            if (!getFromStorage('punnetSettings')) {
                saveToStorage('punnetSettings', {
                    'Small': { punnetsPerCrate: 32, punnetWeightG: 250 },
                    'Medium': { punnetsPerCrate: 20, punnetWeightG: 400 },
                    'Large': { punnetsPerCrate: 8, punnetWeightG: 800 }
                });
            }
            
            if (!getFromStorage('varieties')) {
                saveToStorage('varieties', ['Albion', 'San Andreas', 'Monterey']);
            }
            
            if (!getFromStorage('blocks')) {
                saveToStorage('blocks', ['Block A', 'Block B', 'Block C']);
            }
            
            if (!getFromStorage('currentBatchId')) {
                saveToStorage('currentBatchId', 1);
            }
            
            if (!getFromStorage('harvestRecords')) {
                saveToStorage('harvestRecords', []);
            }
            
            if (!getFromStorage('employees')) {
                saveToStorage('employees', []);
            }
            
            if (!getFromStorage('timeRecords')) {
                saveToStorage('timeRecords', []);
            }
            
            if (!getFromStorage('plantsPerBlock')) {
                saveToStorage('plantsPerBlock', {});
            }
        }
        
        // ============= NAVIGATION =============
        function navigateToScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            document.getElementById(screenId).classList.add('active');
            
            // Show/hide home button
            const homeBtn = document.querySelector('.home-btn');
            if (screenId === 'homeScreen') {
                homeBtn.style.display = 'none';
            } else {
                homeBtn.style.display = 'flex';
            }
            
            // Load screen-specific data
            if (screenId === 'strawberryScreen') {
                loadStrawberryScreen();
            } else if (screenId === 'recordsScreen') {
                loadRecordsScreen();
            } else if (screenId === 'pickingSettingsScreen') {
                loadPickingSettingsScreen();
            } else if (screenId === 'dataSettingsScreen') {
                loadDataSettingsScreen();
            } else if (screenId === 'enrollEmployeeScreen') {
                loadEnrollEmployeeScreen();
            } else if (screenId === 'clockInScreen') {
                loadClockScreen('in');
            } else if (screenId === 'clockOutScreen') {
                loadClockScreen('out');
            } else if (screenId === 'printStickersScreen') {
                loadPrintStickersScreen();
            } else if (screenId === 'timeRecordsScreen') {
                loadTimeRecordsScreen();
            }
        }
        
        function goHome() {
            navigateToScreen('homeScreen');
        }
        
        // ============= TOAST NOTIFICATIONS =============
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ============= UTILITY FUNCTIONS =============
        function normalizeList(text) {
            return text.split('\n')
                .map(item => item.trim())
                .filter(item => item.length > 0);
        }
        
        function generateEmployeeQRCode(employeeName) {
            // Return the employee name as the QR code content
            return employeeName;
        }
        
        // ============= EMPLOYEE FUNCTIONS =============
        function loadEnrollEmployeeScreen() {
            document.getElementById('employeeName').value = '';
            document.getElementById('employeePhone').value = '';
            document.getElementById('employeeEmail').value = '';
        }
        
        function enrollEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const email = document.getElementById('employeeEmail').value.trim();
            
            if (!name) {
                showToast('Please enter employee name');
                return;
            }
            
            const employees = getFromStorage('employees', []);
            
            // Check if employee already exists
            if (employees.find(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                showToast('Employee with this name already exists');
                return;
            }
            
            const newEmployee = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                email: email,
                qrCode: generateEmployeeQRCode(name),
                enrolledDate: new Date().toISOString(),
                photo: null
            };
            
            employees.push(newEmployee);
            saveToStorage('employees', employees);
            
            showToast(`Employee ${name} enrolled successfully!`);
            loadEnrollEmployeeScreen();
        }
        
        function loadClockScreen(action) {
            const employees = getFromStorage('employees', []);
            const gridId = action === 'in' ? 'clockInEmployeeGrid' : 'clockOutEmployeeGrid';
            const grid = document.getElementById(gridId);
            
            if (employees.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">No employees enrolled yet. Please enrol employees first.</p>';
                return;
            }
            
            grid.innerHTML = employees.map(emp => `
                <div class="employee-tile" onclick="selectEmployeeForClock('${emp.id}', '${action}')">
                    <div class="employee-photo">
                        ${emp.photo ? `<img src="${emp.photo}" alt="${emp.name}">` : 'üë§'}
                    </div>
                    <div class="employee-name">${emp.name}</div>
                </div>
            `).join('');
        }
        
        function selectEmployeeForClock(employeeId, action) {
            currentClockEmployee = employeeId;
            currentClockAction = action;
            openClockCamera();
        }
        
        function openClockCamera() {
            const modal = document.getElementById('clockCameraModal');
            const video = document.getElementById('clockVideo');
            const header = document.getElementById('clockModalHeader');
            
            header.textContent = currentClockAction === 'in' ? 'Clock In - Take Photo' : 'Clock Out - Take Photo';
            modal.classList.add('active');
            
            // Reset UI
            video.style.display = 'block';
            document.getElementById('clockPhotoPreview').style.display = 'none';
            document.getElementById('clockCaptureBtn').style.display = 'inline-block';
            document.getElementById('clockConfirmBtn').style.display = 'none';
            document.getElementById('clockRetakeBtn').style.display = 'none';
            
            // Start camera
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' },
                audio: false 
            })
            .then(stream => {
                clockPhotoStream = stream;
                video.srcObject = stream;
            })
            .catch(err => {
                showToast('Could not access camera');
                closeClockCamera();
            });
        }
        
        function captureClockPhoto() {
            const video = document.getElementById('clockVideo');
            const preview = document.getElementById('clockPhotoPreview');
            
            // Create canvas to capture frame
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Get image data
            clockPhotoData = canvas.toDataURL('image/jpeg');
            
            // Show preview
            preview.src = clockPhotoData;
            preview.style.display = 'block';
            video.style.display = 'none';
            
            // Update buttons
            document.getElementById('clockCaptureBtn').style.display = 'none';
            document.getElementById('clockConfirmBtn').style.display = 'inline-block';
            document.getElementById('clockRetakeBtn').style.display = 'inline-block';
        }
        
        function retakeClockPhoto() {
            const video = document.getElementById('clockVideo');
            const preview = document.getElementById('clockPhotoPreview');
            
            video.style.display = 'block';
            preview.style.display = 'none';
            clockPhotoData = null;
            
            document.getElementById('clockCaptureBtn').style.display = 'inline-block';
            document.getElementById('clockConfirmBtn').style.display = 'none';
            document.getElementById('clockRetakeBtn').style.display = 'none';
        }
        
        function confirmClockPhoto() {
            if (!clockPhotoData) return;
            
            const employees = getFromStorage('employees', []);
            const employee = employees.find(emp => emp.id === currentClockEmployee);
            
            if (!employee) {
                showToast('Employee not found');
                closeClockCamera();
                return;
            }
            
            // Update employee photo
            employee.photo = clockPhotoData;
            saveToStorage('employees', employees);
            
            // Record time entry
            const timeRecords = getFromStorage('timeRecords', []);
            timeRecords.push({
                employeeId: employee.id,
                employeeName: employee.name,
                action: currentClockAction,
                timestamp: new Date().toISOString(),
                photo: clockPhotoData
            });
            saveToStorage('timeRecords', timeRecords);
            
            showToast(`${employee.name} clocked ${currentClockAction} successfully!`);
            closeClockCamera();
            navigateToScreen('clockInOutMenuScreen');
        }
        
        function closeClockCamera() {
            if (clockPhotoStream) {
                clockPhotoStream.getTracks().forEach(track => track.stop());
                clockPhotoStream = null;
            }
            clockPhotoData = null;
            document.getElementById('clockCameraModal').classList.remove('active');
        }
        
        function loadPrintStickersScreen() {
            const employees = getFromStorage('employees', []);
            const select = document.getElementById('stickerEmployee');
            
            select.innerHTML = '<option value="">Select Employee</option>' +
                employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            
            document.getElementById('stickerQuantity').value = 10;
            document.getElementById('stickerPreview').innerHTML = '';
        }
        
        function printStickers() {
            const employeeId = document.getElementById('stickerEmployee').value;
            const quantity = parseInt(document.getElementById('stickerQuantity').value);
            
            if (!employeeId) {
                showToast('Please select an employee');
                return;
            }
            
            if (!quantity || quantity < 1) {
                showToast('Please enter a valid quantity');
                return;
            }
            
            const employees = getFromStorage('employees', []);
            const employee = employees.find(emp => emp.id === employeeId);
            
            if (!employee) {
                showToast('Employee not found');
                return;
            }
            
            // Generate QR code using a simple library-free approach
            // For production, you'd want to use a proper QR code library
            const qrData = employee.qrCode;
            
            // Create sticker preview
            const preview = document.getElementById('stickerPreview');
            let html = '<h3 style="margin-top: 30px;">Sticker Preview</h3>';
            html += '<p style="color: #666; margin-bottom: 20px;">Stickers ready to print (placeholder - implement actual QR code generation)</p>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">';
            
            for (let i = 0; i < Math.min(quantity, 12); i++) {
                html += `
                    <div style="border: 2px solid #ddd; padding: 15px; text-align: center; background: white; border-radius: 8px;">
                        <div style="width: 100px; height: 100px; background: #f0f0f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666;">
                            QR Code<br>${employee.name}
                        </div>
                        <div style="font-weight: 500;">${employee.name}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (quantity > 12) {
                html += `<p style="margin-top: 15px; color: #666;">+ ${quantity - 12} more stickers</p>`;
            }
            
            html += '<div class="btn-group"><button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button></div>';
            
            preview.innerHTML = html;
            showToast(`Generated ${quantity} stickers for ${employee.name}`);
        }
        
        function loadTimeRecordsScreen() {
            // Load employee filter
            const employees = getFromStorage('employees', []);
            const select = document.getElementById('timeRecordsEmployee');
            select.innerHTML = '<option value="all">All Employees</option>' +
                employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            
            loadTimeRecords();
        }
        
        function loadTimeRecords() {
            const filter = document.getElementById('timeRecordsFilter').value;
            const employeeFilter = document.getElementById('timeRecordsEmployee').value;
            let records = getFromStorage('timeRecords', []);
            
            // Apply filters
            const now = new Date();
            records = records.filter(record => {
                const recordDate = new Date(record.timestamp);
                
                // Time filter
                let timeMatch = true;
                if (filter === 'today') {
                    timeMatch = recordDate.toDateString() === now.toDateString();
                } else if (filter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    timeMatch = recordDate >= weekAgo;
                } else if (filter === 'month') {
                    timeMatch = recordDate.getMonth() === now.getMonth() && 
                               recordDate.getFullYear() === now.getFullYear();
                }
                
                // Employee filter
                const employeeMatch = employeeFilter === 'all' || record.employeeId === employeeFilter;
                
                return timeMatch && employeeMatch;
            });
            
            // Sort by timestamp descending
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display records
            const container = document.getElementById('timeRecordsContainer');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No time records found</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Action</th>
                                <th>Date & Time</th>
                                <th>Photo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => `
                                <tr>
                                    <td>${record.employeeName}</td>
                                    <td>${record.action === 'in' ? '‚úÖ Clock In' : 'üö™ Clock Out'}</td>
                                    <td>${new Date(record.timestamp).toLocaleString()}</td>
                                    <td>
                                        ${record.photo ? `<img src="${record.photo}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function exportTimeRecords() {
            const filter = document.getElementById('timeRecordsFilter').value;
            const employeeFilter = document.getElementById('timeRecordsEmployee').value;
            let records = getFromStorage('timeRecords', []);
            
            // Apply same filters
            const now = new Date();
            records = records.filter(record => {
                const recordDate = new Date(record.timestamp);
                
                let timeMatch = true;
                if (filter === 'today') {
                    timeMatch = recordDate.toDateString() === now.toDateString();
                } else if (filter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    timeMatch = recordDate >= weekAgo;
                } else if (filter === 'month') {
                    timeMatch = recordDate.getMonth() === now.getMonth() && 
                               recordDate.getFullYear() === now.getFullYear();
                }
                
                const employeeMatch = employeeFilter === 'all' || record.employeeId === employeeFilter;
                
                return timeMatch && employeeMatch;
            });
            
            if (records.length === 0) {
                showToast('No records to export');
                return;
            }
            
            // Create CSV
            const headers = 'timestamp,employee_name,action';
            const rows = records.map(r => 
                `${r.timestamp},${r.employeeName},${r.action}`
            );
            
            const csv = headers + '\n' + rows.join('\n');
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time_records_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${records.length} records`);
        }
        
        // ============= STRAWBERRY SCREEN =============
        function loadStrawberryScreen() {
            const varieties = getFromStorage('varieties', []);
            const blocks = getFromStorage('blocks', []);
            
            // Populate variety dropdown
            const varietySelect = document.getElementById('variety');
            varietySelect.innerHTML = '<option value="">Select Variety</option>' + 
                varieties.map(v => `<option value="${v}">${v}</option>`).join('');
            
            // Populate block dropdown
            const blockSelect = document.getElementById('block');
            blockSelect.innerHTML = '<option value="">Select Block</option>' + 
                blocks.map(b => `<option value="${b}">${b}</option>`).join('');
            
            // Update batch pill
            updateBatchPill();
            
            // Reset picker tallies for new session
            pickerTallies = {};
            updatePickerTally();
        }
        
        function updateBatchPill() {
            const batchId = getFromStorage('currentBatchId', 1);
            document.getElementById('batchPill').textContent = `Batch #${batchId} - ${currentBatchCrates} crates`;
        }
        
        function updatePickerTally() {
            const container = document.getElementById('pickerTallyContainer');
            const list = document.getElementById('pickerTallyList');
            
            if (Object.keys(pickerTallies).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = Object.entries(pickerTallies).map(([picker, count]) => `
                <div class="picker-tally-item">
                    <span class="picker-tally-name">${picker}</span>
                    <div class="picker-tally-count">
                        <input type="number" 
                               value="${count}" 
                               min="0"
                               onchange="updatePickerTallyCount('${picker}', this.value)">
                        <span>crates</span>
                    </div>
                </div>
            `).join('');
        }
        
        function updatePickerTallyCount(picker, newCount) {
            const count = parseInt(newCount) || 0;
            if (count === 0) {
                delete pickerTallies[picker];
            } else {
                pickerTallies[picker] = count;
            }
            updatePickerTally();
            
            // Recalculate total crates
            currentBatchCrates = Object.values(pickerTallies).reduce((sum, count) => sum + count, 0);
            updateBatchPill();
        }
        
        function openScanner() {
            const variety = document.getElementById('variety').value;
            const block = document.getElementById('block').value;
            const size = document.getElementById('size').value;
            
            if (!variety || !block || !size) {
                showToast('Please select variety, block, and size first');
                return;
            }
            
            const overlay = document.getElementById('scannerOverlay');
            overlay.classList.add('active');
            
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    currentStream = stream;
                    const video = document.getElementById('videoPreview');
                    video.srcObject = stream;
                })
                .catch(err => {
                    showToast('Could not access camera');
                    closeScanner();
                });
        }
        
        function closeScanner() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('scannerOverlay').classList.remove('active');
        }
        
        function captureImage() {
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('captureCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            // Get image data
            const imageData = canvas.toDataURL('image/jpeg');
            
            // Parse the data from the image
            // For now, prompt for picker ID since OCR/QR would need external library
            const scanData = prompt('Enter the text from the label (Picker ID):');
            
            if (scanData && scanData.trim()) {
                processScannedData(scanData.trim());
            }
        }
        
        function processScannedData(qrData) {
            const variety = document.getElementById('variety').value;
            const block = document.getElementById('block').value;
            const size = document.getElementById('size').value;
            const isPartial = document.getElementById('partialCrate').checked;
            const manualPunnets = isPartial ? parseInt(document.getElementById('manualPunnetsInput').value) : null;
            
            const punnetSettings = getFromStorage('punnetSettings', {});
            const sizeSettings = punnetSettings[size];
            
            if (!sizeSettings) {
                showToast('Invalid size settings');
                return;
            }
            
            // Check if scanned data is an employee name
            const employees = getFromStorage('employees', []);
            const employee = employees.find(emp => emp.qrCode === qrData || emp.name === qrData);
            
            let pickerId = qrData;
            if (employee) {
                pickerId = employee.name;
            }
            
            // Update picker tally
            if (!pickerTallies[pickerId]) {
                pickerTallies[pickerId] = 0;
            }
            pickerTallies[pickerId]++;
            updatePickerTally();
            
            // Calculate punnets and kg
            let punnetsTotal;
            let crateQty = 1;
            
            if (isPartial && manualPunnets) {
                punnetsTotal = manualPunnets;
            } else {
                punnetsTotal = sizeSettings.punnetsPerCrate;
            }
            
            const kg = (punnetsTotal * sizeSettings.punnetWeightG) / 1000;
            
            // Save record
            const batchId = getFromStorage('currentBatchId', 1);
            const records = getFromStorage('harvestRecords', []);
            
            records.push({
                timestamp: new Date().toISOString(),
                picker_id: pickerId,
                crate_id: qrData,
                variety: variety,
                block: block,
                size: size,
                punnets_per_crate: sizeSettings.punnetsPerCrate,
                crate_qty: crateQty,
                is_partial: isPartial,
                manual_punnets: manualPunnets,
                punnets_total: punnetsTotal,
                punnet_weight_g: sizeSettings.punnetWeightG,
                kg: kg,
                batch_id: batchId,
                scan_raw: qrData
            });
            
            saveToStorage('harvestRecords', records);
            
            currentBatchCrates++;
            updateBatchPill();
            
            document.getElementById('scanStatus').textContent = `Scanned: ${pickerId} - ${punnetsTotal} punnets (${kg.toFixed(1)}kg)`;
            showToast(`Recorded: ${pickerId} - ${kg.toFixed(1)}kg`);
        }
        
        function finishBatch() {
            if (currentBatchCrates === 0) {
                showToast('No crates in current batch');
                return;
            }
            
            // Increment batch ID
            const currentBatchId = getFromStorage('currentBatchId', 1);
            saveToStorage('currentBatchId', currentBatchId + 1);
            
            showToast(`Batch #${currentBatchId} completed with ${currentBatchCrates} crates`);
            
            // Reset for new batch
            currentBatchCrates = 0;
            pickerTallies = {};
            updateBatchPill();
            updatePickerTally();
            
            // Reset form
            document.getElementById('partialCrate').checked = false;
            document.getElementById('manualPunnets').style.display = 'none';
            document.getElementById('manualPunnetsInput').value = '';
        }
        
        // ============= RECORDS SCREEN =============
        function loadRecordsScreen() {
            const varieties = getFromStorage('varieties', []);
            const blocks = getFromStorage('blocks', []);
            
            // Populate filter dropdowns
            const varietyFilter = document.getElementById('filterVariety');
            varietyFilter.innerHTML = '<option value="all">All Varieties</option>' + 
                varieties.map(v => `<option value="${v}">${v}</option>`).join('');
            
            const blockFilter = document.getElementById('filterBlock');
            blockFilter.innerHTML = '<option value="all">All Blocks</option>' + 
                blocks.map(b => `<option value="${b}">${b}</option>`).join('');
            
            applyFilters();
        }
        
        function applyFilters() {
            const records = getFromStorage('harvestRecords', []);
            const timeFilter = document.getElementById('filterTime').value;
            const varietyFilter = document.getElementById('filterVariety').value;
            const blockFilter = document.getElementById('filterBlock').value;
            const groupBy = document.getElementById('filterGroupBy').value;
            
            // Apply filters
            let filtered = records.filter(record => {
                const recordDate = new Date(record.timestamp);
                const today = new Date();
                
                let timeMatch = true;
                switch(timeFilter) {
                    case 'today':
                        timeMatch = recordDate.toDateString() === today.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        timeMatch = recordDate >= weekAgo;
                        break;
                    case 'month':
                        timeMatch = recordDate.getMonth() === today.getMonth() && 
                                   recordDate.getFullYear() === today.getFullYear();
                        break;
                }
                
                const varietyMatch = varietyFilter === 'all' || record.variety === varietyFilter;
                const blockMatch = blockFilter === 'all' || record.block === blockFilter;
                
                return timeMatch && varietyMatch && blockMatch;
            });
            
            // Calculate stats
            let totalCrates = 0;
            let totalPunnets = 0;
            let totalKg = 0;
            
            filtered.forEach(record => {
                totalCrates++;
                totalPunnets += record.punnets_total;
                totalKg += record.kg;
            });
            
            // Calculate kg per plant
            const plantsPerBlock = getFromStorage('plantsPerBlock', {});
            let totalPlants = 0;
            
            // Get unique blocks from filtered records
            const uniqueBlocks = [...new Set(filtered.map(r => r.block))];
            uniqueBlocks.forEach(block => {
                totalPlants += plantsPerBlock[block] || 0;
            });
            
            const kgPerPlant = totalPlants > 0 ? totalKg / totalPlants : 0;
            
            document.getElementById('statCrates').textContent = totalCrates;
            document.getElementById('statPunnets').textContent = totalPunnets;
            document.getElementById('statKg').textContent = totalKg.toFixed(1);
            document.getElementById('statKgPerPlant').textContent = kgPerPlant.toFixed(2);
            
            // Display grouped or detailed records
            if (groupBy !== 'none') {
                displayGroupedRecords(filtered, groupBy);
            }
            
            // Display records table with aggregation by picker and batch
            displayAggregatedRecords(filtered);
        }
        
        function displayGroupedRecords(records, groupBy) {
            const grouped = {};
            
            records.forEach(record => {
                const key = record[groupBy];
                if (!grouped[key]) {
                    grouped[key] = { crates: 0, punnets: 0, kg: 0 };
                }
                grouped[key].crates++;
                grouped[key].punnets += record.punnets_total;
                grouped[key].kg += record.kg;
            });
            
            const container = document.getElementById('groupedContainer');
            container.innerHTML = `
                <h3>Grouped by ${groupBy.charAt(0).toUpperCase() + groupBy.slice(1)}</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>${groupBy.charAt(0).toUpperCase() + groupBy.slice(1)}</th>
                                <th>Crates</th>
                                <th>Punnets</th>
                                <th>Kg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(grouped).map(([key, data]) => `
                                <tr>
                                    <td>${key}</td>
                                    <td>${data.crates}</td>
                                    <td>${data.punnets}</td>
                                    <td>${data.kg.toFixed(1)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function displayAggregatedRecords(records) {
            // Aggregate records by picker and batch
            const aggregated = {};
            
            records.forEach(record => {
                const key = `${record.picker_id}_${record.batch_id}_${record.variety}_${record.block}_${record.size}`;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        picker: record.picker_id,
                        batch: record.batch_id,
                        variety: record.variety,
                        block: record.block,
                        size: record.size,
                        crates: 0,
                        partialPunnets: 0,
                        totalPunnets: 0,
                        totalKg: 0,
                        date: record.timestamp
                    };
                }
                aggregated[key].crates++;
                if (record.is_partial) {
                    aggregated[key].partialPunnets += record.manual_punnets || 0;
                }
                aggregated[key].totalPunnets += record.punnets_total;
                aggregated[key].totalKg += record.kg;
            });
            
            // Convert to array and sort by date
            const aggregatedArray = Object.entries(aggregated).map(([key, data]) => ({
                key: key,
                ...data
            }));
            
            aggregatedArray.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('recordsTableContainer');
            
            if (aggregatedArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No records found</p>';
                return;
            }
            
            container.innerHTML = `
                <h3>All Records (Aggregated by Picker & Batch)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Picker</th>
                                <th>Variety</th>
                                <th>Block</th>
                                <th>Size</th>
                                <th>Crates</th>
                                <th>Partial Punnets</th>
                                <th>Total Kg</th>
                                <th>Batch</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aggregatedArray.map((record, index) => `
                                <tr>
                                    <td>${new Date(record.date).toLocaleDateString()}</td>
                                    <td>${record.picker}</td>
                                    <td>${record.variety}</td>
                                    <td>${record.block}</td>
                                    <td>${record.size}</td>
                                    <td>${record.crates}</td>
                                    <td>${record.partialPunnets || '-'}</td>
                                    <td>${record.totalKg.toFixed(1)}</td>
                                    <td>${record.batch}</td>
                                    <td>
                                        <button class="btn action-btn" onclick="editAggregatedRecord('${record.key}')">‚úèÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function editAggregatedRecord(recordKey) {
            // Find all records matching this key
            const records = getFromStorage('harvestRecords', []);
            const [picker, batch, variety, block, size] = recordKey.split('_');
            
            const matchingRecords = records.filter(r => 
                r.picker_id === picker && 
                r.batch_id === parseInt(batch) && 
                r.variety === variety && 
                r.block === block && 
                r.size === size
            );
            
            if (matchingRecords.length === 0) return;
            
            // Calculate totals
            let totalCrates = matchingRecords.length;
            let partialPunnets = matchingRecords
                .filter(r => r.is_partial)
                .reduce((sum, r) => sum + (r.manual_punnets || 0), 0);
            
            // Populate edit modal
            const employees = getFromStorage('employees', []);
            const varieties = getFromStorage('varieties', []);
            const blocks = getFromStorage('blocks', []);
            
            document.getElementById('editRecordIndex').value = recordKey;
            
            const editPicker = document.getElementById('editPicker');
            editPicker.innerHTML = '<option value="">Manual Entry</option>' + 
                employees.map(emp => `<option value="${emp.name}" ${emp.name === picker ? 'selected' : ''}>${emp.name}</option>`).join('');
            if (!employees.find(emp => emp.name === picker)) {
                editPicker.value = '';
                editPicker.insertAdjacentHTML('afterbegin', `<option value="${picker}" selected>${picker}</option>`);
            }
            
            const editVariety = document.getElementById('editVariety');
            editVariety.innerHTML = varieties.map(v => `<option value="${v}" ${v === variety ? 'selected' : ''}>${v}</option>`).join('');
            
            const editBlock = document.getElementById('editBlock');
            editBlock.innerHTML = blocks.map(b => `<option value="${b}" ${b === block ? 'selected' : ''}>${b}</option>`).join('');
            
            document.getElementById('editSize').value = size;
            document.getElementById('editCrates').value = totalCrates;
            document.getElementById('editPartialPunnets').value = partialPunnets || '';
            
            document.getElementById('editRecordModal').classList.add('active');
        }
        
        function saveEditedRecord() {
            const recordKey = document.getElementById('editRecordIndex').value;
            const [oldPicker, oldBatch, oldVariety, oldBlock, oldSize] = recordKey.split('_');
            
            const newPicker = document.getElementById('editPicker').value;
            const newVariety = document.getElementById('editVariety').value;
            const newBlock = document.getElementById('editBlock').value;
            const newSize = document.getElementById('editSize').value;
            const newCrates = parseInt(document.getElementById('editCrates').value);
            const newPartialPunnets = parseInt(document.getElementById('editPartialPunnets').value) || 0;
            
            if (confirm('Are you happy with changes?')) {
                const records = getFromStorage('harvestRecords', []);
                
                // Find and update matching records
                const matchingIndices = [];
                records.forEach((r, index) => {
                    if (r.picker_id === oldPicker && 
                        r.batch_id === parseInt(oldBatch) && 
                        r.variety === oldVariety && 
                        r.block === oldBlock && 
                        r.size === oldSize) {
                        matchingIndices.push(index);
                    }
                });
                
                // Remove old records
                for (let i = matchingIndices.length - 1; i >= 0; i--) {
                    records.splice(matchingIndices[i], 1);
                }
                
                // Add new records
                const punnetSettings = getFromStorage('punnetSettings', {});
                const sizeSettings = punnetSettings[newSize];
                
                for (let i = 0; i < newCrates; i++) {
                    const isPartial = (i === newCrates - 1) && newPartialPunnets > 0;
                    const punnets = isPartial ? newPartialPunnets : sizeSettings.punnetsPerCrate;
                    const kg = (punnets * sizeSettings.punnetWeightG) / 1000;
                    
                    records.push({
                        timestamp: new Date().toISOString(),
                        picker_id: newPicker,
                        crate_id: `edited_${Date.now()}_${i}`,
                        variety: newVariety,
                        block: newBlock,
                        size: newSize,
                        punnets_per_crate: sizeSettings.punnetsPerCrate,
                        crate_qty: 1,
                        is_partial: isPartial,
                        manual_punnets: isPartial ? newPartialPunnets : null,
                        punnets_total: punnets,
                        punnet_weight_g: sizeSettings.punnetWeightG,
                        kg: kg,
                        batch_id: parseInt(oldBatch),
                        scan_raw: `edited_${Date.now()}`
                    });
                }
                
                saveToStorage('harvestRecords', records);
                closeEditRecordModal();
                loadRecordsScreen();
                showToast('Record updated successfully');
            }
        }
        
        function deleteEditedRecord() {
            if (confirm('Are you happy with changes? This will delete the record.')) {
                const recordKey = document.getElementById('editRecordIndex').value;
                const [picker, batch, variety, block, size] = recordKey.split('_');
                
                let records = getFromStorage('harvestRecords', []);
                records = records.filter(r => !(
                    r.picker_id === picker && 
                    r.batch_id === parseInt(batch) && 
                    r.variety === variety && 
                    r.block === block && 
                    r.size === size
                ));
                
                saveToStorage('harvestRecords', records);
                closeEditRecordModal();
                loadRecordsScreen();
                showToast('Record deleted');
            }
        }
        
        function closeEditRecordModal() {
            document.getElementById('editRecordModal').classList.remove('active');
        }
        
        function addManualRecord() {
            const employees = getFromStorage('employees', []);
            const varieties = getFromStorage('varieties', []);
            const blocks = getFromStorage('blocks', []);
            
            document.getElementById('manualDate').valueAsDate = new Date();
            
            const pickerSelect = document.getElementById('manualPicker');
            pickerSelect.innerHTML = '<option value="">Select or enter manually</option>' + 
                employees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            const varietySelect = document.getElementById('manualVariety');
            varietySelect.innerHTML = '<option value="">Select Variety</option>' + 
                varieties.map(v => `<option value="${v}">${v}</option>`).join('');
            
            const blockSelect = document.getElementById('manualBlock');
            blockSelect.innerHTML = '<option value="">Select Block</option>' + 
                blocks.map(b => `<option value="${b}">${b}</option>`).join('');
            
            document.getElementById('manualSize').value = '';
            document.getElementById('manualCrates').value = '';
            document.getElementById('manualPartialPunnets').value = '';
            
            document.getElementById('manualRecordModal').classList.add('active');
        }
        
        function saveManualRecord() {
            const date = document.getElementById('manualDate').value;
            const picker = document.getElementById('manualPicker').value;
            const variety = document.getElementById('manualVariety').value;
            const block = document.getElementById('manualBlock').value;
            const size = document.getElementById('manualSize').value;
            const crates = parseInt(document.getElementById('manualCrates').value);
            const partialPunnets = parseInt(document.getElementById('manualPartialPunnets').value) || 0;
            
            if (!date || !picker || !variety || !block || !size || !crates) {
                showToast('Please fill in all required fields');
                return;
            }
            
            const punnetSettings = getFromStorage('punnetSettings', {});
            const sizeSettings = punnetSettings[size];
            
            if (!sizeSettings) {
                showToast('Invalid size settings');
                return;
            }
            
            const records = getFromStorage('harvestRecords', []);
            const batchId = getFromStorage('currentBatchId', 1);
            
            // Add records for each crate
            for (let i = 0; i < crates; i++) {
                const isPartial = (i === crates - 1) && partialPunnets > 0;
                const punnets = isPartial ? partialPunnets : sizeSettings.punnetsPerCrate;
                const kg = (punnets * sizeSettings.punnetWeightG) / 1000;
                
                records.push({
                    timestamp: new Date(date).toISOString(),
                    picker_id: picker,
                    crate_id: `manual_${Date.now()}_${i}`,
                    variety: variety,
                    block: block,
                    size: size,
                    punnets_per_crate: sizeSettings.punnetsPerCrate,
                    crate_qty: 1,
                    is_partial: isPartial,
                    manual_punnets: isPartial ? partialPunnets : null,
                    punnets_total: punnets,
                    punnet_weight_g: sizeSettings.punnetWeightG,
                    kg: kg,
                    batch_id: batchId,
                    scan_raw: `manual_${Date.now()}`
                });
            }
            
            saveToStorage('harvestRecords', records);
            closeManualRecordModal();
            loadRecordsScreen();
            showToast('Manual record added successfully');
        }
        
        function closeManualRecordModal() {
            document.getElementById('manualRecordModal').classList.remove('active');
        }
        
        function exportCSV() {
            const records = getFromStorage('harvestRecords', []);
            const timeFilter = document.getElementById('filterTime').value;
            const varietyFilter = document.getElementById('filterVariety').value;
            const blockFilter = document.getElementById('filterBlock').value;
            
            // Apply same filters as display
            let filtered = records.filter(record => {
                const recordDate = new Date(record.timestamp);
                const today = new Date();
                
                let timeMatch = true;
                switch(timeFilter) {
                    case 'today':
                        timeMatch = recordDate.toDateString() === today.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        timeMatch = recordDate >= weekAgo;
                        break;
                    case 'month':
                        timeMatch = recordDate.getMonth() === today.getMonth() && 
                                   recordDate.getFullYear() === today.getFullYear();
                        break;
                }
                
                const varietyMatch = varietyFilter === 'all' || record.variety === varietyFilter;
                const blockMatch = blockFilter === 'all' || record.block === blockFilter;
                
                return timeMatch && varietyMatch && blockMatch;
            });
            
            if (filtered.length === 0) {
                showToast('No records to export');
                return;
            }
            
            // Create CSV content
            const headers = 'timestamp,picker_id,crate_id,variety,block,size,punnets_per_crate,crate_qty,is_partial,manual_punnets,punnets_total,punnet_weight_g,kg,batch_id,scan_raw';
            const rows = filtered.map(r => 
                `${r.timestamp},${r.picker_id},${r.crate_id},${r.variety},${r.block},${r.size},${r.punnets_per_crate},${r.crate_qty},${r.is_partial},${r.manual_punnets || ''},${r.punnets_total},${r.punnet_weight_g},${r.kg},${r.batch_id},"${r.scan_raw}"`
            );
            
            const csv = headers + '\n' + rows.join('\n');
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `harvest_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${filtered.length} records`);
        }
        
        function clearAllRecords() {
            if (confirm('Are you sure you want to delete ALL harvest records? This cannot be undone.')) {
                saveToStorage('harvestRecords', []);
                saveToStorage('currentBatchId', 1);
                currentBatchCrates = 0;
                loadRecordsScreen();
                showToast('All records cleared');
            }
        }
        
        // ============= SETTINGS SCREENS =============
        function loadPickingSettingsScreen() {
            const punnetSettings = getFromStorage('punnetSettings', {});
            const varieties = getFromStorage('varieties', []);
            const blocks = getFromStorage('blocks', []);
            
            // Load punnet settings
            document.getElementById('smallPunnets').value = punnetSettings.Small?.punnetsPerCrate || 32;
            document.getElementById('smallWeight').value = punnetSettings.Small?.punnetWeightG || 250;
            document.getElementById('mediumPunnets').value = punnetSettings.Medium?.punnetsPerCrate || 20;
            document.getElementById('mediumWeight').value = punnetSettings.Medium?.punnetWeightG || 400;
            document.getElementById('largePunnets').value = punnetSettings.Large?.punnetsPerCrate || 8;
            document.getElementById('largeWeight').value = punnetSettings.Large?.punnetWeightG || 800;
            
            // Load master lists
            document.getElementById('varietiesList').value = varieties.join('\n');
            document.getElementById('blocksList').value = blocks.join('\n');
        }
        
        function savePickingSettings() {
            // Save punnet settings
            const punnetSettings = {
                'Small': {
                    punnetsPerCrate: parseInt(document.getElementById('smallPunnets').value) || 32,
                    punnetWeightG: parseInt(document.getElementById('smallWeight').value) || 250
                },
                'Medium': {
                    punnetsPerCrate: parseInt(document.getElementById('mediumPunnets').value) || 20,
                    punnetWeightG: parseInt(document.getElementById('mediumWeight').value) || 400
                },
                'Large': {
                    punnetsPerCrate: parseInt(document.getElementById('largePunnets').value) || 8,
                    punnetWeightG: parseInt(document.getElementById('largeWeight').value) || 800
                }
            };
            saveToStorage('punnetSettings', punnetSettings);
            
            // Save master lists
            const varieties = normalizeList(document.getElementById('varietiesList').value);
            const blocks = normalizeList(document.getElementById('blocksList').value);
            
            saveToStorage('varieties', varieties);
            saveToStorage('blocks', blocks);
            
            showToast('Picking settings saved successfully!');
        }
        
        function loadDataSettingsScreen() {
            const blocks = getFromStorage('blocks', []);
            const plantsPerBlock = getFromStorage('plantsPerBlock', {});
            
            const container = document.getElementById('plantsPerBlockContainer');
            container.innerHTML = blocks.map(block => `
                <div class="form-group">
                    <label for="plants_${block.replace(/\s/g, '_')}">${block}</label>
                    <input type="number" 
                           id="plants_${block.replace(/\s/g, '_')}" 
                           value="${plantsPerBlock[block] || ''}" 
                           placeholder="Number of plants"
                           min="0">
                </div>
            `).join('');
        }
        
        function savePlantsPerBlock() {
            const blocks = getFromStorage('blocks', []);
            const plantsPerBlock = {};
            
            blocks.forEach(block => {
                const inputId = `plants_${block.replace(/\s/g, '_')}`;
                const value = parseInt(document.getElementById(inputId).value);
                if (value && value > 0) {
                    plantsPerBlock[block] = value;
                }
            });
            
            saveToStorage('plantsPerBlock', plantsPerBlock);
            showToast('Plants per block saved successfully!');
        }
        
        // ============= EVENT WIRING =============
        // Partial crate checkbox handler
        document.getElementById('partialCrate').addEventListener('change', function(e) {
            const manualInput = document.getElementById('manualPunnets');
            if (e.target.checked) {
                manualInput.style.display = 'block';
                document.getElementById('manualPunnetsInput').required = true;
            } else {
                manualInput.style.display = 'none';
                document.getElementById('manualPunnetsInput').required = false;
                document.getElementById('manualPunnetsInput').value = '';
            }
        });
        
        // Filter change handlers
        document.getElementById('filterTime').addEventListener('change', applyFilters);
        document.getElementById('filterVariety').addEventListener('change', applyFilters);
        document.getElementById('filterBlock').addEventListener('change', applyFilters);
        document.getElementById('filterGroupBy').addEventListener('change', applyFilters);
        
        // Page visibility handler to stop camera when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentStream) {
                closeScanner();
            }
        });
        
        // Initialize app on load
        window.addEventListener('DOMContentLoaded', function() {
            initializeStorage();
            loadStrawberryScreen();
        });
    </script>
    
    <!-- ============= PATCH AREA START ============= -->
    <script id="hotfixes">
        // Reserved for hot fixes if needed
    </script>
    <!-- ============= PATCH AREA END ============= -->
</body>
</html>
