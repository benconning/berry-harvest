<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berry Harvest</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px 0; }
    .topbar { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    button { padding: 8px 12px; cursor: pointer; }
    select, input, textarea { padding: 6px 8px; }
    video { width: 100%; max-width: 460px; border: 1px solid #ccc; border-radius: 8px; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:8px; padding:10px; margin-top:10px; }
    #log { white-space: pre-wrap; background:#f8f8ff; border:1px solid #ddd; padding:10px; max-width: 740px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    .hidden { display:none; }
    .pill { border:1px solid #ccc; padding:4px 8px; border-radius:999px; background:#f7f7ff; }
    .muted { color:#666; font-size: 13px; }
    .status { font-size:12px; color:#444; }
    textarea { width: 100%; min-height: 90px; }
    .spacer { flex:1 1 auto; }
    .warn { color:#b00020; font-size: 13px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#14a34b; color:#fff; padding:10px 14px; border-radius:8px; display:none; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .kpi > span { background:#f7f7ff; border:1px solid #ccc; border-radius:999px; padding:4px 10px; }
    .w100 { width:100%; }
  </style>
</head>
<body>
  <h1>üçì Berry Harvest</h1>

  <div class="topbar">
    <button id="btnScanner"  onclick="goScanner()">üì∑ Scanner</button>
    <button id="btnRecords"  onclick="goRecords()">üìÑ Records</button>
    <button id="btnSettings" onclick="goSettings()">‚öôÔ∏è Settings</button>
    <span id="appStatus" class="status">Status: loading‚Ä¶</span>
  </div>

  <!-- ========== Scanner Screen ========== -->
  <div id="scannerScreen">
    <div class="card">
      <strong>Context (sticky)</strong>
      <div class="row" style="margin-top:6px">
        <label>Variety:
          <select id="varietySelect"><option value="">-- choose --</option></select>
        </label>
        <label>Block:
          <select id="blockSelect"><option value="">-- choose --</option></select>
        </label>
        <label>Size:
          <select id="sizeSelect">
            <option>Small</option><option>Medium</option><option>Large</option>
          </select>
        </label>
        <span class="muted">These stay until you change them.</span>
      </div>
      <div id="ctxWarn" class="warn hidden">Please choose Variety, Block, and Size before capturing.</div>
    </div>

    <div class="card">
      <strong>Scanner</strong>
      <div class="row" style="margin-top:6px">
        <label for="cameraSelect">Camera:</label>
        <select id="cameraSelect"></select>
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <span class="pill" id="batchCount">Batch #<span id="batchIdLabel">1</span>: 0 crates</span>
        <span class="spacer"></span>
        <button id="completeBatchBtn" title="Finish this batch and start a new one">‚úÖ Complete Batch</button>
      </div>

      <video id="preview" autoplay muted playsinline></video>

      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="partialToggle"> Partial crate</label>
        <label>Manual punnets:
          <input id="manualPunnets" type="number" min="1" step="1" value="2" disabled>
        </label>
        <span class="muted">Use this only if the crate isn't full.</span>
      </div>

      <p><strong>Pending scan:</strong> <span id="lastScan">‚Äî</span></p>
      <div id="detectNote" class="muted hidden">Detected! Tap <strong>Capture</strong> to save, or <strong>Rescan</strong>.</div>
      <div class="row" id="captureRow" style="display:none">
        <button id="captureBtn">‚úÖ Capture</button>
        <button id="rescanBtn">‚Üª Rescan</button>
      </div>

      <div id="log" class="muted">Ready‚Ä¶</div>
    </div>
  </div>

  <!-- ========== Records Screen ========== -->
  <div id="recordsScreen" class="hidden">
    <div class="card">
      <div class="row">
        <label>Time:
          <select id="dateFilter">
            <option value="today">Today</option>
            <option value="7">Last 7 days</option>
            <option value="month">This month</option>
            <option value="all">All</option>
          </select>
        </label>
        <label>Variety:
          <select id="filterVariety"><option value="__all__">All</option></select>
        </label>
        <label>Block:
          <select id="filterBlock"><option value="__all__">All</option></select>
        </label>
        <label>Picker:
          <select id="filterPicker"><option value="__all__">All</option></select>
        </label>
        <label>Group by:
          <select id="groupBy">
            <option value="variety">Variety</option>
            <option value="block">Block</option>
            <option value="picker_id">Picker</option>
          </select>
        </label>
        <button id="exportCSVBtn">Export CSV</button>
        <button id="clearAllBtn" style="margin-left:auto;">Clear All</button>
      </div>

      <div class="kpi">
        <span>Rows: <strong id="rowsCount">0</strong></span>
        <span>Punnets: <strong id="totalPunnets">0</strong></span>
        <span>Kg: <strong id="totalKg">0.00</strong></span>
        <span>Crates: <strong id="totalCrates">0</strong></span>
      </div>

      <h3 style="margin-top:12px;">Summary</h3>
      <div style="max-height: 260px; overflow:auto;">
        <table id="summaryTable">
          <thead>
            <tr>
              <th id="summaryColHeader">Variety</th>
              <th>Crates</th>
              <th>Punnets</th>
              <th>Kg</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin-top:12px;">Rows</h3>
      <div style="max-height: 300px; overflow:auto;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Time</th><th>Picker</th><th>Crate</th><th>Variety</th><th>Block</th>
              <th>Size</th><th>Punnets</th><th>Kg</th><th>Batch</th><th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ========== Settings Screen ========== -->
  <div id="settingsScreen" class="hidden">
    <div class="card">
      <h2>‚öôÔ∏è Punnet Settings</h2>
      <p>Change the number of punnets per crate and the weight per punnet (grams). Saved on this device.</p>
      <table>
        <thead><tr><th>Size</th><th>Punnets per Crate</th><th>Punnet Weight (g)</th></tr></thead>
        <tbody>
          <tr><td>Small</td><td><input id="smallPunnets" type="number" value="32" /></td><td><input id="smallWeight" type="number" value="250" /></td></tr>
          <tr><td>Medium</td><td><input id="mediumPunnets" type="number" value="20" /></td><td><input id="mediumWeight" type="number" value="400" /></td></tr>
          <tr><td>Large</td><td><input id="largePunnets" type="number" value="8" /></td><td><input id="largeWeight" type="number" value="800" /></td></tr>
        </tbody>
      </table>
      <button id="saveSettingsBtn" style="margin-top:10px;">üíæ Save Punnet Settings</button>
    </div>

    <div class="card">
      <h2>üìã Master Lists</h2>
      <p>Enter one per line. You can also paste values separated by commas or with ‚Äú\n‚Äù.</p>
      <div class="row">
        <div style="flex:1 1 300px;">
          <h3 style="margin:6px 0 6px;">Varieties</h3>
          <textarea id="varietiesText"></textarea>
        </div>
        <div style="flex:1 1 300px;">
          <h3 style="margin:6px 0 6px;">Blocks</h3>
          <textarea id="blocksText"></textarea>
        </div>
      </div>
      <button id="saveListsBtn">üíæ Save Lists</button>
    </div>
  </div>

  <div id="toast" class="toast">Captured</div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const setStatus = (t)=> { const el = $('appStatus'); if (el) el.textContent = t; };
    const fmtKg = (n) => Number(n).toFixed(2);
    const nowISO = () => new Date().toISOString();
    const show = (screen)=>{ ['scanner','records','settings'].forEach(s=>$(s+'Screen').classList.add('hidden')); $(screen+'Screen').classList.remove('hidden'); setStatus('Status: showing '+screen); };
    window.goScanner = ()=> show('scanner');
    window.goRecords = ()=> { renderRecords(); show('records'); };
    window.goSettings = ()=> { stopScanner(); loadSettingsIntoForm(); loadListsIntoForm(); show('settings'); };

    // ---------- Punnet settings ----------
    const defaultPunnetSettings = { Small:{punnetsPerCrate:32,punnetWeightG:250}, Medium:{punnetsPerCrate:20,punnetWeightG:400}, Large:{punnetsPerCrate:8,punnetWeightG:800} };
    const getPunnetSettings = ()=> JSON.parse(localStorage.getItem('punnetSettings')||JSON.stringify(defaultPunnetSettings));
    const setPunnetSettings = (o)=> localStorage.setItem('punnetSettings', JSON.stringify(o));
    function loadSettingsIntoForm(){
      const s = getPunnetSettings();
      $('smallPunnets').value = s.Small.punnetsPerCrate; $('smallWeight').value = s.Small.punnetWeightG;
      $('mediumPunnets').value = s.Medium.punnetsPerCrate; $('mediumWeight').value = s.Medium.punnetWeightG;
      $('largePunnets').value = s.Large.punnetsPerCrate; $('largeWeight').value = s.Large.punnetWeightG;
    }
    $('saveSettingsBtn').onclick = ()=>{
      const s = {
        Small:{punnetsPerCrate:parseInt($('smallPunnets').value||'0',10),punnetWeightG:parseInt($('smallWeight').value||'0',10)},
        Medium:{punnetsPerCrate:parseInt($('mediumPunnets').value||'0',10),punnetWeightG:parseInt($('mediumWeight').value||'0',10)},
        Large:{punnetsPerCrate:parseInt($('largePunnets').value||'0',10),punnetWeightG:parseInt($('largeWeight').value||'0',10)}
      };
      setPunnetSettings(s); alert('‚úÖ Punnet settings saved!');
    };

    // ---------- Master lists (normalize, dedupe) ----------
    const defaultVarieties = ['Albion','Camarosa','Ventana'];
    const defaultBlocks = ['GH1-R01','GH2-R12','Block 5'];
    function normalizeList(input, fallback){
      let arr;
      try {
        if (Array.isArray(input)) arr = input.slice();
        else if (typeof input === 'string') arr = [input];
        else arr = fallback.slice();
      } catch { arr = fallback.slice(); }
      arr = arr.flatMap(item =>
        String(item).replace(/\\n/g, '\n').split(/[\r\n,]+/)
      ).map(s => s.trim()).filter(Boolean);
      const seen = new Set(), out = [];
      for (const x of arr) if (!seen.has(x)) { seen.add(x); out.push(x); }
      return out.length ? out : fallback.slice();
    }
    function readList(key, fallback){
      const raw = localStorage.getItem(key);
      if (!raw) return fallback.slice();
      try { return normalizeList(JSON.parse(raw), fallback); }
      catch { return normalizeList(raw, fallback); }
    }
    function writeList(key, list){ localStorage.setItem(key, JSON.stringify(normalizeList(list, []))); }
    const getVarieties = ()=> readList('varieties', defaultVarieties);
    const setVarieties = (l)=> writeList('varieties', l);
    const getBlocks = ()=> readList('blocks', defaultBlocks);
    const setBlocks  = (l)=> writeList('blocks', l);

    function loadListsIntoForm(){
      $('varietiesText').value = getVarieties().join('\n');
      $('blocksText').value = getBlocks().join('\n');
    }
    $('saveListsBtn').onclick = ()=>{
      const v = normalizeList($('varietiesText').value, defaultVarieties);
      const b = normalizeList($('blocksText').value, defaultBlocks);
      if (!v.length || !b.length){ alert('Please enter at least one Variety and one Block.'); return; }
      setVarieties(v); setBlocks(b);
      populateVarietyBlockOptions();
      alert('‚úÖ Master lists saved!');
    };

    function populateVarietyBlockOptions(){
      const vlist = getVarieties(), blist = getBlocks();
      const vs = $('varietySelect'), bs = $('blockSelect');
      const oldV = vs.value, oldB = bs.value;
      vs.innerHTML = '<option value="">-- choose --</option>';
      vlist.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; vs.appendChild(o); });
      bs.innerHTML = '<option value="">-- choose --</option>';
      blist.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; bs.appendChild(o); });
      if (vlist.includes(oldV)) vs.value = oldV;
      if (blist.includes(oldB)) bs.value = oldB;
    }

    // ---------- Sticky context ----------
    const getCtx = ()=> JSON.parse(localStorage.getItem('scanContext')||'{}');
    const setCtx = (o)=> localStorage.setItem('scanContext', JSON.stringify(o));
    const varietySelect = $('varietySelect'), blockSelect = $('blockSelect'), sizeSelect = $('sizeSelect');
    populateVarietyBlockOptions();
    (()=>{ const c=getCtx(); if (c.variety) varietySelect.value=c.variety; if (c.block) blockSelect.value=c.block; if (c.size) sizeSelect.value=c.size; })();
    [varietySelect,blockSelect,sizeSelect].forEach(el=> el.addEventListener('change', ()=> setCtx({ variety:varietySelect.value, block:blockSelect.value, size:sizeSelect.value }) ));

    // ---------- Records + batch ----------
    const getRecords = ()=> JSON.parse(localStorage.getItem('harvestRecords')||'[]');
    const setRecords = (arr)=> localStorage.setItem('harvestRecords', JSON.stringify(arr));
    const getBatchId = ()=> parseInt(localStorage.getItem('currentBatchId')||'1',10);
    const setBatchId = (n)=> { localStorage.setItem('currentBatchId', String(n)); $('batchIdLabel').textContent = n; };

    // ensure label shows current batch on load
    setBatchId(getBatchId());

    // Complete Batch with confirmation and hard reset of counter
    $('completeBatchBtn').onclick = () => {
      const current = getBatchId();
      const count = Number(($('batchCount').dataset.count) || '0');
      const ok = confirm(`Complete Batch #${current}? This will finalize ${count} crate(s) and start Batch #${current + 1}.`);
      if (!ok) return;
      const next = current + 1;
      setBatchId(next);
      // reset the visible and internal counter for the NEW batch
      const el = $('batchCount');
      el.dataset.count = 0;
      el.textContent = `Batch #${next}: 0 crates`;
    };

    // ---------- QR parsing ----------
    function parseKV(text){
      const out = { raw: text||'' };
      if(!text) return out;
      text.split(/[;,\n]/).forEach(pair=>{
        const [k,...rest] = pair.split('=');
        if(rest.length){ out[k.trim().toLowerCase()] = rest.join('=').trim(); }
      });
      if (!out.picker && /^[A-Za-z]\d{2,}$/.test(out.raw||'')) out.picker = out.raw.trim();
      return out;
    }

    // ---------- Scanner + capture ----------
    const logEl = $('log'), lastScanEl = $('lastScan'), detectNote = $('detectNote'), ctxWarn = $('ctxWarn');
    const cameraSelect = $('cameraSelect'), startBtn=$('startBtn'), stopBtn=$('stopBtn');
    const batchCountEl = $('batchCount'), partialToggle=$('partialToggle'), manualPunnets=$('manualPunnets');
    const captureRow=$('captureRow'), captureBtn=$('captureBtn'), rescanBtn=$('rescanBtn'), toast=$('toast');
    let codeReader = null, pendingText='';

    function log(msg){ if (logEl) logEl.textContent += '\n' + msg; }
    function setButtons(scanning){ if (startBtn) startBtn.disabled = scanning; if (stopBtn) stopBtn.disabled = !scanning; }
    partialToggle.onchange = ()=>{ manualPunnets.disabled = !partialToggle.checked; };

    async function listCameras(){
      try{
        const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`camera ${i+1}`; cameraSelect.appendChild(o); });
        log('Found cameras: '+devices.length);
        if (!devices.length) log('No cameras found. Check browser permission.');
      }catch(e){ log('Error listing cameras: '+e.message); }
    }

    async function startScanner(){
      try{
        setButtons(true); pendingText=''; lastScanEl.textContent='‚Äî'; detectNote.classList.add('hidden'); captureRow.style.display='none'; ctxWarn.classList.add('hidden');
        if (codeReader) await codeReader.reset();
        codeReader = new ZXing.BrowserMultiFormatReader();
        const deviceId = cameraSelect.value || undefined;
        await codeReader.decodeFromVideoDevice(deviceId, 'preview', async (result, err) => {
          if (result) {
            await pauseScanner();
            pendingText = result.getText();
            lastScanEl.textContent = pendingText || '(empty)';
            detectNote.classList.remove('hidden');
            captureRow.style.display = 'flex';
            log('Detected QR ‚Äî paused. Tap Capture to save or Rescan.');
          } else if (err && !(err instanceof ZXing.NotFoundException)) {
            log('Decode error: ' + err);
          }
        });
        log('Scanner started.');
      }catch(e){ log('Start error: '+(e.message||e)); setButtons(false); }
    }
    async function pauseScanner(){ try{ if (codeReader) await codeReader.reset(); }catch(e){ log('Pause error: '+e.message);} finally{ setButtons(false);} }
    async function stopScanner(){ pendingText=''; captureRow.style.display='none'; lastScanEl.textContent='‚Äî'; detectNote.classList.add('hidden'); try{ if (codeReader) await codeReader.reset(); log('Scanner stopped.'); }catch(e){ log('Stop error: '+e.message);} finally{ setButtons(false);} }
    startBtn.onclick = startScanner; stopBtn.onclick = stopScanner;

    captureBtn.onclick = async ()=>{
      if (!pendingText) return;
      const ctx = getCtx();
      if (!ctx.variety || !ctx.block || !sizeSelect.value){ ctxWarn.classList.remove('hidden'); return; }
      handleScan(pendingText);
      showToast('Captured');
      pendingText=''; captureRow.style.display='none'; detectNote.classList.add('hidden');
      await startScanner();
    };
    rescanBtn.onclick = async ()=>{ pendingText=''; captureRow.style.display='none'; detectNote.classList.add('hidden'); lastScanEl.textContent='‚Äî'; await startScanner(); };

    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 1000); }

    function handleScan(rawText){
      const kv = parseKV(rawText);
      const ctx = getCtx();
      const size = ctx.size || 'Small', variety = ctx.variety || '', block = ctx.block || '';
      const settings = getPunnetSettings(), sizeCfg = settings[size] || settings.Small;
      const isPartial = !!partialToggle.checked, manual = parseInt(manualPunnets.value||'0',10);
      const punnets = isPartial ? Math.max(1, manual) : sizeCfg.punnetsPerCrate;
      const kg = (punnets * sizeCfg.punnetWeightG) / 1000;

      const rec = {
        timestamp: nowISO(),
        picker_id: kv.picker || 'Unknown',
        crate_id:  kv.crate || kv.crateid || '',
        variety, block, size,
        punnets_per_crate: sizeCfg.punnetsPerCrate,
        is_partial: isPartial,
        manual_punnets: isPartial ? punnets : null,
        crate_qty: 1,
        punnets_total: punnets,
        punnet_weight_g: sizeCfg.punnetWeightG,
        kg: Number(kg.toFixed(3)),
        batch_id: getBatchId(),
        scan_raw: rawText
      };

      const all = getRecords(); all.push(rec); setRecords(all);

      // increment batch counter (for the current batch)
      const currentCount = Number(batchCountEl.dataset.count || '0') + 1;
      batchCountEl.dataset.count = currentCount;
      batchCountEl.textContent = `Batch #${getBatchId()}: ${currentCount} crates`;

      if (isPartial) { partialToggle.checked = false; manualPunnets.disabled = true; }
      log(`Captured: [Batch #${rec.batch_id}] ${rec.picker_id} ‚Ä¢ ${rec.size} ‚Ä¢ ${rec.punnets_total} punnets = ${rec.kg} kg`);
    }

    // ---------- Records page ----------
    const dateFilter = $('dateFilter'),
          filterVariety = $('filterVariety'),
          filterBlock   = $('filterBlock'),
          filterPicker  = $('filterPicker'),
          groupBy       = $('groupBy');

    [dateFilter, filterVariety, filterBlock, filterPicker, groupBy].forEach(el=>{
      el.addEventListener('change', ()=> renderRecords());
    });

    function withinTime(ts, filterVal){
      const t = new Date(ts), now = new Date();
      if (filterVal==='all') return true;
      if (filterVal==='today'){ const start=new Date(now.getFullYear(),now.getMonth(),now.getDate()); return t>=start; }
      if (filterVal==='7'){ const start=new Date(now); start.setDate(now.getDate()-6); start.setHours(0,0,0,0); return t>=start; }
      if (filterVal==='month'){ const start=new Date(now.getFullYear(),now.getMonth(),1); return t>=start; }
      return true;
    }

    function populateRecordFilters(rows){
      // Unique sets
      const uniq = (arr)=> Array.from(new Set(arr.filter(Boolean))).sort();
      const vSet = uniq(rows.map(r=>r.variety||''));
      const bSet = uniq(rows.map(r=>r.block||''));
      const pSet = uniq(rows.map(r=>r.picker_id||''));
      // Fill selects (keep current value if still present)
      const fill = (sel, values)=>{
        const old = sel.value;
        sel.innerHTML = '<option value="__all__">All</option>' + values.map(v=>`<option>${v}</option>`).join('');
        if (values.includes(old)) sel.value = old; else sel.value = '__all__';
      };
      fill(filterVariety, vSet);
      fill(filterBlock, bSet);
      fill(filterPicker, pSet);
    }

    const rowsCount=$('rowsCount'), totalPunnets=$('totalPunnets'), totalKg=$('totalKg'), totalCrates=$('totalCrates');
    const recordsTableBody = $('recordsTable').querySelector('tbody');
    const summaryTableBody = $('summaryTable').querySelector('tbody');
    const summaryColHeader = $('summaryColHeader');

    function applyFieldFilters(rows){
      const v = filterVariety.value, b = filterBlock.value, p = filterPicker.value;
      return rows.filter(r =>
        (v==='__all__' || r.variety===v) &&
        (b==='__all__' || r.block===b) &&
        (p==='__all__' || r.picker_id===p)
      );
    }

    function renderRecords(){
      const all = getRecords();
      // First, time filter
      const inTime = all.filter(r => withinTime(r.timestamp, dateFilter.value||'today'));
      // Populate drop-downs from time-filtered rows (so options are relevant to that period)
      populateRecordFilters(inTime);
      // Apply field filters
      const rows = applyFieldFilters(inTime);

      // Totals (crates = number of rows, since crate_qty=1)
      const punnetsSum = rows.reduce((s,r)=> s + Number(r.punnets_total||0), 0);
      const kgSum      = rows.reduce((s,r)=> s + Number(r.kg||0), 0);
      const cratesSum  = rows.reduce((s,r)=> s + Number(r.crate_qty||1), 0);

      rowsCount.textContent   = rows.length;
      totalPunnets.textContent= punnetsSum;
      totalKg.textContent     = fmtKg(kgSum);
      totalCrates.textContent = cratesSum;

      // Summary (group by)
      const key = groupBy.value || 'variety';
      summaryColHeader.textContent = key === 'picker_id' ? 'Picker' : key.charAt(0).toUpperCase()+key.slice(1);
      const groups = {};
      rows.forEach(r=>{
        const k = r[key] || '(blank)';
        if (!groups[k]) groups[k] = { crates:0, punnets:0, kg:0 };
        groups[k].crates += Number(r.crate_qty||1);
        groups[k].punnets += Number(r.punnets_total||0);
        groups[k].kg += Number(r.kg||0);
      });
      summaryTableBody.innerHTML = '';
      Object.entries(groups).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([name, g])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${g.crates}</td><td>${g.punnets}</td><td>${fmtKg(g.kg)}</td>`;
        summaryTableBody.appendChild(tr);
      });
      if (!Object.keys(groups).length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="muted">No rows for selected filters</td>`;
        summaryTableBody.appendChild(tr);
      }

      // Rows table
      recordsTableBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.timestamp).toLocaleString()}</td>
          <td>${r.picker_id}</td>
          <td>${r.crate_id||''}</td>
          <td>${r.variety||''}</td>
          <td>${r.block||''}</td>
          <td>${r.size}</td>
          <td>${r.punnets_total}</td>
          <td>${fmtKg(r.kg)}</td>
          <td>#${r.batch_id||''}</td>
          <td class="muted" title="${(r.scan_raw||'').replace(/"/g,'&quot;')}">${(r.scan_raw||'').slice(0,20)}</td>`;
        recordsTableBody.appendChild(tr);
      });
    }

    // Export / Clear
    $('exportCSVBtn').onclick = ()=>{
      const cols=['timestamp','picker_id','crate_id','variety','block','size','punnets_per_crate','crate_qty','is_partial','manual_punnets','punnets_total','punnet_weight_g','kg','batch_id','scan_raw'];
      const all=getRecords();
      const inTime = all.filter(r => withinTime(r.timestamp, dateFilter.value||'today'));
      const rows = applyFieldFilters(inTime);
      const header=cols.join(','); const body=rows.map(r=>cols.map(c=>{ const v=(r[c]==null)?'':String(r[c]); return /[,"\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v; }).join(','));
      const csv=[header,...body].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`harvest_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
    };
    $('clearAllBtn').onclick = ()=>{ if(confirm('Clear ALL saved records on this device?')){ setRecords([]); renderRecords(); } };

    // Init
    (async ()=>{ setStatus('Status: JS loaded, showing scanner'); await listCameras(); show('scanner'); log('Tap Start ‚Üí scan ‚Üí Capture. Use Complete Batch to increment batch and reset counter.'); })();
  })();
  </script>
</body>
</html>
